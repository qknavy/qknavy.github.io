import{_ as p,c as e,a as s,b as a,d as c,e as o,r as l,o as i}from"./app-CUmx0lpF.js";const u={},k={href:"https://www.confluent.io/blog/transactions-apache-kafka/",target:"_blank",rel:"noopener noreferrer"};function r(d,n){const t=l("ExternalLinkIcon");return i(),e("div",null,[n[1]||(n[1]=s(`<div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><p>消息中间件是我们在业务开发，特别是在做分布式业务开发过程中经常用到的技术，它不仅可以用来实现异步解藕、削峰限流，甚至还可以基于可靠消息来做分布式事务。这里就非常有必要来聊一下常见的几种消息中间件的事务消息机制</p></div><h2 id="_1、kafka" tabindex="-1"><a class="header-anchor" href="#_1、kafka"><span>1、Kafka</span></a></h2><p>kafka所谓的事务其实主要指的是生产者在生产消息时的事务特性，这个特性是在2017年0.11.0.0版本之后才引进的，通过事务kafka可以保证跨生产者会话的消息幂等发送</p><h3 id="_1-1、kafka事务消息的场景" tabindex="-1"><a class="header-anchor" href="#_1-1、kafka事务消息的场景"><span>1.1、kafka事务消息的场景</span></a></h3><p>想象一下几种场景：</p><ul><li>假设只有一个broker，一个topic的分区只有一个副本，如果我们要发送多条消息，想要让这些消息全部成功或者全部失败，怎么做？</li><li>如果生产者发送消息到多个topic或者多个partition，他们有可能分布在不同的服务器上，我们需要他们全部发送成功或者全部发送失败，怎么做？</li><li>假如消费者和生产者在同一块代码中，从上游接收消息，经过处理后发给下游，这个时候如要要保证接受消息和发送消息同时成功，怎么做？</li></ul><h3 id="_1-2、如何发送事务消息" tabindex="-1"><a class="header-anchor" href="#_1-2、如何发送事务消息"><span>1.2、如何发送事务消息</span></a></h3><p>在kafka中，生产者跟事务相关的有五个方法：</p><table><thead><tr><th>对象</th><th>描述</th></tr></thead><tbody><tr><td>initTransactions()</td><td>初始化事务</td></tr><tr><td>beginTransaction()</td><td>开启事务</td></tr><tr><td>commitTransaction()</td><td>提交事务</td></tr><tr><td>abortTransaction()</td><td>中止事务</td></tr><tr><td>sendOffsetsToTransaction()</td><td>sendOffsetsToTransaction 这个方法是消费者和生产者在同一段代码使用的（从上游接收消费发送给下游），在提交的时候把消费的消息的 offset 发给 consumer Corordinator（看接口方法上的注释）。</td></tr></tbody></table><p>如果我们要在一个事务中发送多条kafka消息，可以这样做：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 事务 ID，唯一</span></span>
<span class="line">pros<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;transactional.id&quot;</span><span class="token punctuation">,</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>pros<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 初始化事务</span></span>
<span class="line">producer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;transaction-test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;transaction-test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;transaction-test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 提交事务</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KafkaException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 中止事务</span></span>
<span class="line">    producer<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3、kafka事务消息的原理" tabindex="-1"><a class="header-anchor" href="#_1-3、kafka事务消息的原理"><span>1.3、kafka事务消息的原理</span></a></h3>`,12)),a("p",null,[a("a",k,[n[0]||(n[0]=c("【资料】",-1)),o(t)])]),n[2]||(n[2]=s(`<p><img src="http://blog.shengxiao.tech/images/image-20251224083843485.png" alt="image-20251224083843485"></p><ul><li><p>A：生产者与事务协调器的交互 在执行事务时，生产者会在以下时间点向事务协调器发出请求：</p><ul><li>initTransactions API 向协调器注册一个 transactional.id。此时，协调器会关闭所有具有该 transactional.id 的挂起事务，并将时间戳（epoch）提升以排除僵尸进程。每个生产者会话中，这种情况只发生一次。</li><li>当生产者在一个事务中首次向某个分区发送数据时，该分区会首先向协调器进行注册。</li><li>当应用程序调用commitTransaction或abortTransaction时，会向协调器发送请求，以启动两阶段提交协议。</li></ul></li><li><p>B：协调器与事务日志交互</p><p>随着事务的进行，生产者发送上述请求以更新协调器上的事务状态。事务协调器将其负责的每个事务的状态保存在内存中，并将该状态写入事务日志（该日志以三种方式进行复制，因此具有持久性）。</p><p>事务协调器是唯一能够读写事务日志的组件。如果某个给定的代理失败，则会选举一个新的协调器作为已失效代理所拥有的事务日志分区的领导者，该协调器会从传入分区中读取消息，以重建这些分区中事务的内存状态。</p></li><li><p>C：生产者向目标主题分区写入数据</p><p>在与协调器在事务中注册新分区后，生产者正常向实际分区发送数据。这完全与普通的<code>producer.send</code>流程相同，但会进行一些额外的验证，以确保生产者未被隔离。</p></li><li><p>D：协调器与主题分区交互</p><p>在生产者发起提交（或中止）后，协调器开始执行两阶段提交协议。</p><p>在第一阶段，协调器将其内部状态更新为“prepare_commit”，并在事务日志中更新此状态。一旦完成此操作，无论发生什么情况，该事务都将被保证提交。 然后，协调器开始第二阶段，在此阶段，它将事务提交标记写入属于该事务的主题分区。</p><p>这些事务标记不对应用程序公开，但供处于读提交模式（read_committed mode）的消费者使用，以过滤掉来自已中止事务的消息，并且不返回属于未完成事务（即那些在日志中但未关联事务标记的消息）的消息。</p><p>一旦标记完成，事务协调器就会将该事务标记为“完成”，然后生产者就可以开始下一个事务了。</p></li></ul><h2 id="_2、rabbitmq" tabindex="-1"><a class="header-anchor" href="#_2、rabbitmq"><span>2、RabbitMq</span></a></h2><h3 id="_2-1、rabbitmq的架构设计" tabindex="-1"><a class="header-anchor" href="#_2-1、rabbitmq的架构设计"><span>2.1、RabbitMQ的架构设计</span></a></h3><p><img src="http://blog.shengxiao.tech/images/image-20251224090940617.png" alt="image-20251224090940617"></p><p>RabbitMq的整体架构图如上图所示，主要成员角色也是有生产者、broker和消费者。</p><p>生产者连接到broker，而broker为了实现资源隔离定义了虚拟机vhost的概念，虚拟机里边将交换机Exchanger和队列queue进行绑定。生产者将消息发送到交换机关联的队列中，消费者通过channel建立和broker的连接之后就可以消费队列中的消息</p><h3 id="_2-2、rabbitmq发送事务消息" tabindex="-1"><a class="header-anchor" href="#_2-2、rabbitmq发送事务消息"><span>2.2、RabbitMQ发送事务消息</span></a></h3><p>RabbitMQ发送事务消息也很简单，首先需要通过<code>txSelect()</code>来开启事务，最后通过<code>txCommit()</code>来提交事务，如下所示：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">	channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 发送消息</span></span>
<span class="line">    <span class="token comment">// String exchange, String routingKey, BasicProperties props, byte[] body</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;QUEUE_NAME&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">txCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">txRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息已经回滚&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>通过这种方式就可以将消息发送到<code>QUEUE_NAME</code>对应的路由规则匹配的队列上去了</p></blockquote><p>只要保证<code>channel.txCommit()</code>执行成功，就能保证消息一定能够正确发送到broker</p><h3 id="_2-3、rabbitmq的事务消息原理" tabindex="-1"><a class="header-anchor" href="#_2-3、rabbitmq的事务消息原理"><span>2.3、RabbitMQ的事务消息原理</span></a></h3><h4 id="_2-3-1、transaction消息流程" tabindex="-1"><a class="header-anchor" href="#_2-3-1、transaction消息流程"><span>2.3.1、Transaction消息流程</span></a></h4><p>通过上面的示例可以完成一次事务消息的投递，具体交互流程如下：</p><p><img src="http://blog.shengxiao.tech/images/image-20251224145855284.png" alt="image-20251224145855284"></p><p>只有接收到了服务端的Tx.Commit-OK指令，消息才算真正的提交成功了。</p><p>当时这里有个问题，在事务消息模式下，生产者是阻塞的，也就是说上一个消息未提交之前是不能再次发送新的消息，这会影响到生产者的效率，所以生产上一般会禁用这种模式，SpringBoot项目中可以通过下面参数配置：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">rabbitTemplate<span class="token punctuation">.</span><span class="token function">setChannelTransacted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_2-3-2、confirm模式" tabindex="-1"><a class="header-anchor" href="#_2-3-2、confirm模式"><span>2.3.2、Confirm模式</span></a></h4><p>confirm模式和事务模式差不多，区别在于tx模式下生产者发送消息后需要等待调用tx.commit并且等到服务端返回Commit-OK之后才算完成一次消息生产；而在confirm模式下，生产者每次发送消息服务端都会返回一个相应结果，标识此次消息发送请求服务端是否接收成功</p><p><img src="http://blog.shengxiao.tech/images/image-20251224150845739.png" alt="image-20251224150845739"></p><h5 id="_2-3-2-1、单次确认" tabindex="-1"><a class="header-anchor" href="#_2-3-2-1、单次确认"><span>2.3.2.1、单次确认</span></a></h5><p>代码如下：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 开启发送方确认模式</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 普通 Confirm，发送一条，确认一条</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送成功&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-2-2、批量确认" tabindex="-1"><a class="header-anchor" href="#_2-3-2-2、批量确认"><span>2.3.2.2、批量确认</span></a></h5><p>当时这样发送一条确认一条效率确实不是很高，所以RabbitMQ又提供了批量确认的方式</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 发送消息</span></span>
<span class="line">        <span class="token comment">// String exchange, String routingKey, BasicProperties props, byte[] body</span></span>
<span class="line">        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;QUEUE_NAME&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg <span class="token operator">+</span><span class="token string">&quot;-&quot;</span><span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 批量确认结果，ACK 如果是 Multiple=True，代表 ACK 里面的 Delivery-Tag 之前的消息都被确认了</span></span>
<span class="line">    <span class="token comment">// 比如 5 条消息可能只收到 1 个 ACK，也可能收到 2 个（抓包才看得到）</span></span>
<span class="line">    <span class="token comment">// 直到所有信息都发布，只要有一个未被 Broker 确认就会 IOException</span></span>
<span class="line">    channel<span class="token punctuation">.</span><span class="token function">waitForConfirmsOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完毕，批量确认成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 发生异常，可能需要对所有消息进行重发</span></span>
<span class="line">    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样一来，就可以保证示例中这一批次生产的五条消息要么同时发送成功，要么同时失败</p><h5 id="_2-3-2-3、异步批量确认" tabindex="-1"><a class="header-anchor" href="#_2-3-2-3、异步批量确认"><span>2.3.2.3、异步批量确认</span></a></h5><p>不仅如此，为了提升效率，RabbitMQ还提供了一种异步确认的方式</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 用来维护未确认消息的 deliveryTag</span></span>
<span class="line"><span class="token keyword">final</span> <span class="token class-name">SortedSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> confirmSet <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSortedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span></span>
<span class="line"><span class="token class-name">TreeSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 这里不会打印所有响应的 ACK；ACK 可能有多个，有可能一次确认多条，也有可能一次确认一条</span></span>
<span class="line"><span class="token comment">// 异步监听确认和未确认的消息</span></span>
<span class="line"><span class="token comment">// 如果要重复运行，先停掉之前的生产者，清空队列</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfirmListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleNack</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">    	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Broker 未确认消息，标识：&quot;</span> <span class="token operator">+</span> deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    	<span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        	<span class="token comment">// headSet 表示后面参数之前的所有元素，全部删除</span></span>
<span class="line">        	confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        	confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    	<span class="token comment">// 这里添加重发的方法</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleAck</span><span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multiple<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// 如果 true 表示批量执行了 deliveryTag 这个值以前（小于 deliveryTag 的）的所有消息，如果为 false 的话表示单条确认</span></span>
<span class="line">		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Broker 已确认消息，标识：%d，多个消息：%b&quot;</span><span class="token punctuation">,</span> deliveryTag<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        	<span class="token comment">// headSet 表示后面参数之前的所有元素，全部删除</span></span>
<span class="line">        	confirmSet<span class="token punctuation">.</span><span class="token function">headSet</span><span class="token punctuation">(</span>deliveryTag <span class="token operator">+</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        	<span class="token comment">// 只移除一个元素</span></span>
<span class="line">        	confirmSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;未确认的消息:&quot;</span><span class="token operator">+</span>confirmSet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 开启发送方确认模式</span></span>
<span class="line">channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">long</span> nextSeqNo <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token comment">// 发送消息</span></span>
<span class="line">	<span class="token comment">// String exchange, String routingKey, BasicProperties props, byte[] body</span></span>
<span class="line">	channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token constant">QUEUE_NAME</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>msg <span class="token operator">+</span><span class="token string">&quot;-&quot;</span><span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	confirmSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>nextSeqNo<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;所有消息:&quot;</span><span class="token operator">+</span>confirmSet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在SpringBoot项目中可以像这样添加ack监听：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line">rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> cause<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败：&quot;</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;发送异常：&quot;</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、rocketmq" tabindex="-1"><a class="header-anchor" href="#_3、rocketmq"><span>3、RocketMq</span></a></h2><h3 id="_3-1、rocketmq的事务消息流程" tabindex="-1"><a class="header-anchor" href="#_3-1、rocketmq的事务消息流程"><span>3.1、RocketMQ的事务消息流程</span></a></h3><p><img src="http://blog.shengxiao.tech/images/image-20251224154023077.png" alt="image-20251224154023077"></p><p>如上图所示，RocketMQ的事务消息主要是基于消息的“半状态”实现的，具体步骤如下：</p><ul><li>生产者向broker发送一条Half消息，这条消息即使发送成功了，消费者也是无法消费的</li><li>broker收到这个Half消息后往生产者回应一个ack消息，确认收到</li><li>生产者接收到ack消息后就可以通知业务代码区执行自己的本地事务业务逻辑了</li><li>本地业务逻辑执行成功后本地事务提交，并且会通知broker进行消息的commit或者rollback，一旦消息commit，消费者就可以消费到这条消息了</li><li>在某些特殊的情况下，比如网络超时等，生产者往broker发送的commit或者rollback的通知broker未能收到，这个时候broker在等待一定的时间之后就会主动查询生产者的本地事务状态</li><li>如果本地事务状态成功，则会重新指定第④步的commit，本地事务失败则会进行rollback</li></ul><p>上面提到的broker要回查本地事务的状态，也就是说它要知道我们本地事务的执行状态。如何实现呢？</p><p>RocketMQ提供了一个事件回调接口<code>TransactionListener</code>,我们可以在它的<code>executeLocalTransaction</code>方法中去编写我们的本地事务逻辑：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// local transaction process, return bollback, commit or unknown</span></span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;executeLocalTransaction:&quot;</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个接口必须要返回本地事务的几种状态：</p><ul><li>COMMIT：表示事务执行成功，正常提交</li><li>ROLLBACK：表示本地事务执行失败，事务回滚</li><li>UNKNOWN：表示本地事务状态未知</li></ul><p>在这个接口中还提供了另外一个方法<code>checkLocalTransaction</code>，这个方法就是让我们去编写回查本地事务状态的方法</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">RocketMQLocalTransactionState</span> <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;checkLocalTransaction:&quot;</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">RocketMQLocalTransactionState</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>但是RocketMQ也不是无限地回查，默认的回查次数是15次。第一次间隔时间是6秒，后续每次间隔60秒</p></blockquote><h2 id="_4、总结" tabindex="-1"><a class="header-anchor" href="#_4、总结"><span>4、总结</span></a></h2><p>以上三个消息中间件应该是我们生活中最常见的消息中间件，我们可以结合自己业务场景合理选择，同样的，这些消息中间件的事务消息适用的场景可能也不太一样，也需要我们根据具体情况具体考虑</p><hr><p><img src="http://blog.shengxiao.tech/images/subscribe1.png" alt="点我关注"></p>`,51))])}const v=p(u,[["render",r]]),b=JSON.parse('{"path":"/blogs/mq/changjianxiaoxizhongjianjianzhongdeshiwuxiaoxi.html","title":"一篇文章弄清楚常见中间件的事务消息","lang":"en-US","frontmatter":{"title":"一篇文章弄清楚常见中间件的事务消息","date":"2025-12-24T00:00:00.000Z","categories":["mq","中间件"],"tags":["mq","kafka","rabbitmq","rocketmq"]},"headers":[{"level":2,"title":"1、Kafka","slug":"_1、kafka","link":"#_1、kafka","children":[{"level":3,"title":"1.1、kafka事务消息的场景","slug":"_1-1、kafka事务消息的场景","link":"#_1-1、kafka事务消息的场景","children":[]},{"level":3,"title":"1.2、如何发送事务消息","slug":"_1-2、如何发送事务消息","link":"#_1-2、如何发送事务消息","children":[]},{"level":3,"title":"1.3、kafka事务消息的原理","slug":"_1-3、kafka事务消息的原理","link":"#_1-3、kafka事务消息的原理","children":[]}]},{"level":2,"title":"2、RabbitMq","slug":"_2、rabbitmq","link":"#_2、rabbitmq","children":[{"level":3,"title":"2.1、RabbitMQ的架构设计","slug":"_2-1、rabbitmq的架构设计","link":"#_2-1、rabbitmq的架构设计","children":[]},{"level":3,"title":"2.2、RabbitMQ发送事务消息","slug":"_2-2、rabbitmq发送事务消息","link":"#_2-2、rabbitmq发送事务消息","children":[]},{"level":3,"title":"2.3、RabbitMQ的事务消息原理","slug":"_2-3、rabbitmq的事务消息原理","link":"#_2-3、rabbitmq的事务消息原理","children":[]}]},{"level":2,"title":"3、RocketMq","slug":"_3、rocketmq","link":"#_3、rocketmq","children":[{"level":3,"title":"3.1、RocketMQ的事务消息流程","slug":"_3-1、rocketmq的事务消息流程","link":"#_3-1、rocketmq的事务消息流程","children":[]}]},{"level":2,"title":"4、总结","slug":"_4、总结","link":"#_4、总结","children":[]}],"git":{"createdTime":1766566253000,"updatedTime":1766567077000,"contributors":[{"name":"qknavy","email":"qknavy@aliyun.com","commits":2}]},"filePathRelative":"blogs/mq/常见消息中间件中的事务消息.md"}');export{v as comp,b as data};
