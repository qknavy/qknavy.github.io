import{_ as o,c as l,b as a,a as e,d as t,e as p,r as c,o as i}from"./app-CzV27ad6.js";const r={},u={href:"https://seata.apache.org/zh-cn/docs/user/configuration/nacos",target:"_blank",rel:"noopener noreferrer"},d={href:"https://seata.apache.org/zh-cn/docs/user/registry/nacos/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://seata.apache.org/zh-cn/docs/user/txgroup/transaction-group-and-ha",target:"_blank",rel:"noopener noreferrer"};function m(v,s){const n=c("ExternalLinkIcon");return i(),l("div",null,[s[3]||(s[3]=a("blockquote",null,[a("p",null,"本文主要介绍了seata的配置中心和注册中心的用法，以及在seata中事务分组的概念和使用场景")],-1)),s[4]||(s[4]=a("h2",{id:"_1、seata配置中心",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#_1、seata配置中心"},[a("span",null,"1、Seata配置中心")])],-1)),a("p",null,[a("a",u,[s[0]||(s[0]=t("官网资料",-1)),p(n)])]),s[5]||(s[5]=e(`<p>Seata支持哪些配置中心?</p><ol><li>nacos</li><li>consul</li><li>apollo</li><li>etcd</li><li>zookeeper</li><li>file (读本地文件, 包含conf、properties、yml配置文件的支持)</li></ol><p>在seata的安装包<code>conf</code>目录下有一个<code>application.example.yml</code>文件，这个文件里有各种配置中心的配置示例</p><h3 id="_1-1、nacos配置" tabindex="-1"><a class="header-anchor" href="#_1-1、nacos配置"><span>1.1、nacos配置</span></a></h3><p>参考<code>application.example.yml</code>文件中nacos的配置</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos 、 consul 、 apollo 、 zk  、 etcd3</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.109<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">context-path</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment">##if use MSE Nacos with auth, mutex with username/password attribute</span></span>
<span class="line">      <span class="token comment">#access-key:</span></span>
<span class="line">      <span class="token comment">#secret-key:</span></span>
<span class="line">      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>替换<code>application.yml</code>文件中的原配置</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> file</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改完后重启</p><h3 id="_1-2、推送配置" tabindex="-1"><a class="header-anchor" href="#_1-2、推送配置"><span>1.2、推送配置</span></a></h3><p>在seata的安装包<code>script/config-center</code>，目录下对应有各个seata支持的配置中心的推送脚本，比如nacos目录下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ubuntu@ubuntu-server-mixer:~/tools/seata/seata/script/config-center/nacos$ ll</span>
<span class="line">total <span class="token number">24</span></span>
<span class="line">drwxr-xr-x <span class="token number">2</span> ubuntu ubuntu <span class="token number">4096</span> Dec <span class="token number">30</span> <span class="token number">21</span>:55 ./</span>
<span class="line">drwxr-xr-x <span class="token number">7</span> ubuntu ubuntu <span class="token number">4096</span> Dec <span class="token number">30</span> <span class="token number">21</span>:46 <span class="token punctuation">..</span>/</span>
<span class="line">-rw-r--r-- <span class="token number">1</span> ubuntu ubuntu <span class="token number">2877</span> Jan  <span class="token number">6</span>  <span class="token number">2023</span> nacos-config-interactive.py</span>
<span class="line">-rwxr-xr-x <span class="token number">1</span> ubuntu ubuntu <span class="token number">3463</span> Jan  <span class="token number">6</span>  <span class="token number">2023</span> nacos-config-interactive.sh*</span>
<span class="line">-rw-r--r-- <span class="token number">1</span> ubuntu ubuntu <span class="token number">1927</span> Jan  <span class="token number">6</span>  <span class="token number">2023</span> nacos-config.py</span>
<span class="line">-rwxr-xr-x <span class="token number">1</span> ubuntu ubuntu <span class="token number">2851</span> Jan  <span class="token number">6</span>  <span class="token number">2023</span> nacos-config.sh*</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中分为py脚本和shell脚本，带<code>interactive</code>的是交互式的脚本，也就是会在执行的时候提示输入相关的参数，比如nacos主机、端口号、账号密码等等，不带<code>interactive</code>的是需要在执行的时候填对应的参数的，比如：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">-h: nacos主机</span>
<span class="line">-p: nacos端口号</span>
<span class="line">-t: nacos租户，也就是命名空间的ID</span>
<span class="line">-u: nacos账号</span>
<span class="line">-w: nacos密码</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以直接执行<code>sh nacos-config-interactive.sh</code>，等到执行完成之后可以看到在nacos的<code>配置管理</code>&gt;<code>配置列表</code>菜单下多出了一百多条配置信息，这些信息源自seata安装目录下的<code>script/config-server/config.txt</code>文件，所以可以提前修改好这个文件，特别是下面几个配置项：</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># 修改为自己的seata地址</span></span>
<span class="line"><span class="token key attr-name">service.default.grouplist</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.0.109:8091</span></span>
<span class="line"><span class="token comment"># 改为数据库存储，这个时候需要新建一个数据库，并且执行seata安装目录下的script/server/db下对应数据库类型的sql脚本，比如我的是mysql，就执行mysql.sql</span></span>
<span class="line"><span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span></span>
<span class="line"><span class="token comment"># 修改数据库的连接信息</span></span>
<span class="line"><span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span class="token comment"># 我自己建的数据库名称为seata-2.0.0</span></span>
<span class="line"><span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.0.109:3306/seata-2.0.0?useUnicode=true&amp;rewriteBatchedStatements=true</span></span>
<span class="line"><span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span></span>
<span class="line"><span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">root</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3、集中配置" tabindex="-1"><a class="header-anchor" href="#_1-3、集中配置"><span>1.3、集中配置</span></a></h3><p>上述推送的配置是每个配置项作为一个dataId，非常不便于管理，seata从1.4.2版本之后支持将这些文件集中到一个配置文件里边，seata的nacos的配置在<code>ConfigNacosProperties</code>这个类中，如下图所示：</p><p><img src="http://blog.shengxiao.tech/images/image-20251231082606110.png" alt="image-20251231082606110"></p><p>可以看到默认的dataId是<code>seata.properties</code>，但是之前在配置seata-server的时候默认的dataId又是<code>seataConfig.properties</code>，所以要注意前后一致。我们这里统一用<code>seataConfig.properties</code></p><h3 id="_1-4、修改客户端配置" tabindex="-1"><a class="header-anchor" href="#_1-4、修改客户端配置"><span>1.4、修改客户端配置</span></a></h3><p>在上一篇文章的<code>下单</code>案例的基础之上，我们给每个seata事务参与者添加对应的配置</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">seata.data-source-proxy-mode</span><span class="token punctuation">=</span><span class="token value attr-value">AT</span></span>
<span class="line"><span class="token key attr-name">seata.config.type</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.config.nacos.group</span><span class="token punctuation">=</span><span class="token value attr-value">SEATA_GROUP</span></span>
<span class="line"><span class="token key attr-name">seata.config.nacos.username</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.config.nacos.password</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.config.nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.0.109:8848</span></span>
<span class="line"><span class="token key attr-name">seata.config.nacos.data-id</span><span class="token punctuation">=</span><span class="token value attr-value">seataServer.properties</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5、执行接口" tabindex="-1"><a class="header-anchor" href="#_1-5、执行接口"><span>1.5、执行接口</span></a></h3><p>配置完成后，将四个应用都启动起来，然后用postman调用一下，并且在order服务里打一个断点，可以看到当程序执行到order的时候seata控制台多了两条全局锁信息和一条</p><p><img src="http://blog.shengxiao.tech/images/image-20251231083857814.png" alt="image-20251231083857814"></p><p><img src="http://blog.shengxiao.tech/images/image-20251231084140023.png" alt="image-20251231084140023"></p><p>同时，在user的数据库和product的数据库和order的数据库中的<code>undo_log</code>表也多了一条记录：</p><p><img src="http://blog.shengxiao.tech/images/image-20251231084350854.png" alt="image-20251231084350854"></p><p>其中rollback_info信息copy出来如下：</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.undo.BranchUndoLog&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;xid&quot;</span><span class="token operator">:</span><span class="token string">&quot;172.27.0.1:8091:370026985090600977&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;branchId&quot;</span><span class="token operator">:</span><span class="token number">370026985090600980</span><span class="token punctuation">,</span><span class="token property">&quot;sqlUndoLogs&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;java.util.ArrayList&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.undo.SQLUndoLog&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;sqlType&quot;</span><span class="token operator">:</span><span class="token string">&quot;INSERT&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span><span class="token string">&quot;mall_order&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;beforeImage&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.TableRecords$EmptyTableRecords&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span><span class="token string">&quot;mall_order&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rows&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;java.util.ArrayList&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">&quot;afterImage&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.TableRecords&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span><span class="token string">&quot;mall_order&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;rows&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;java.util.ArrayList&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Row&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;fields&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;java.util.ArrayList&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Field&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;keyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;NULL&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">-5</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;java.lang.Long&quot;</span><span class="token punctuation">,</span><span class="token number">19600</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Field&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;keyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;NULL&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Field&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;order_id&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;keyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;PRIMARY_KEY&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Field&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;product_id&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;keyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;NULL&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;A10021&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token property">&quot;@class&quot;</span><span class="token operator">:</span><span class="token string">&quot;org.apache.seata.rm.datasource.sql.struct.Field&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;keyType&quot;</span><span class="token operator">:</span><span class="token string">&quot;NULL&quot;</span><span class="token punctuation">,</span><span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;10010&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>也就是对应事务数据的事务操作前和操作后的镜像，待跳过断点将程序执行完后<code>undo_log</code>日志也会自动删除，而数据库中的余额、库存和订单仍然能够保持数据一致，也就是我们的分布式事务仍然是生效的</p><p>但是这里还有一个问题，在content字段中可以看到<code>serialzer=jackson</code>字样，这是因为默认采用的<code>jackson</code>序列化方式</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">client.undo.logSerialization</span><span class="token punctuation">=</span><span class="token value attr-value">jackson</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>seata支持多种序列化方式，比如kryo，所以接下来给nacos上的配置改为kryo，并且给所有的seata事务参与方都添加<code>kryo</code>的jar包，否则会提示xxxClassNotFound</p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.esotericsoftware<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kryo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.0.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>de.javakaffee<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kryo-serializers<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.45<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重启后再次执行，可以看到已经编程了kryo了</p><p><img src="http://blog.shengxiao.tech/images/image-20251231091140926.png" alt="image-20251231091140926"></p><p>而<code>rollback_info</code>内容也看不懂了：</p><p><img src="http://blog.shengxiao.tech/images/image-20251231091244679.png" alt="image-20251231091244679"></p><blockquote><p>这里为什么换成kryo？因人因业务场景而异，只是演示多一种可能多一种选择，kryo相对来说会有更快的序列化和反序列化以及更小的序列化后的数据体积，但是在可读性上确实不如我们习以为常的json</p><p>为什么要用配置中心呢？主要目的是为了进行配置的统一管理，在客户端只需要简单配置一下对应的nacos地址就可以了</p></blockquote><h2 id="_2、seata注册中心" tabindex="-1"><a class="header-anchor" href="#_2、seata注册中心"><span>2、Seata注册中心</span></a></h2>`,42)),a("p",null,[a("a",d,[s[1]||(s[1]=t("官网资料",-1)),p(n)])]),s[6]||(s[6]=e(`<p>Seata支持哪些注册中心?</p><ol><li>eureka</li><li>consul</li><li>nacos</li><li>etcd</li><li>zookeeper</li><li>sofa</li><li>redis</li><li>file (直连)</li></ol><p>这里还是以nacos注册中心为例</p><h3 id="_2-1、修改seata-server的配置" tabindex="-1"><a class="header-anchor" href="#_2-1、修改seata-server的配置"><span>2.1、修改seata-server的配置</span></a></h3><p>修改seata-server安装目录下<code>conf/application.yaml</code>，添加对应nacos注册中心的配置</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line">  <span class="token key atrule">registry</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># support: nacos 、 eureka 、 redis 、 zk  、 consul 、 etcd3 、 sofa</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">    <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.109<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default</span>
<span class="line">      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">context-path</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment">##if use MSE Nacos with auth, mutex with username/password attribute</span></span>
<span class="line">      <span class="token comment">#access-key:</span></span>
<span class="line">      <span class="token comment">#secret-key: </span></span>
<span class="line">      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改完成后，重启seata-server，可以看到在nacos的控制台的服务列表中看到我们的seata-server服务了</p><p><img src="http://blog.shengxiao.tech/images/image-20251231150205423.png" alt="image-20251231150205423"></p><h3 id="_2-2、客户端配置修改" tabindex="-1"><a class="header-anchor" href="#_2-2、客户端配置修改"><span>2.2、客户端配置修改</span></a></h3><p>修改各个seata分布式事务参与方的配置文件</p><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">seata.registry.type</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.cluster</span><span class="token punctuation">=</span><span class="token value attr-value">default</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.application</span><span class="token punctuation">=</span><span class="token value attr-value">seata-server</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.group</span><span class="token punctuation">=</span><span class="token value attr-value">SEATA_GROUP</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.username</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.password</span><span class="token punctuation">=</span><span class="token value attr-value">nacos</span></span>
<span class="line"><span class="token key attr-name">seata.registry.nacos.server-addr</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.0.109:8848</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置文件都修改完后重新执行，发现分布式事务还是生效的</p><p>那为啥还要引入注册中心呢？个人理解还是为了统一管理。之前原始的方式是在客户端要配置<code>default.grouplist</code>指向对应的seata-server，引入配置中心和注册中心之后这些就不需要在客户端进行配置了，seata会从注册中心去找<code>seata.registry.nacos.cluster</code>配置对应的集群，比如这里是<code>default</code>集群，也就是我们注册到nacos上的seata-server服务</p><p><img src="http://blog.shengxiao.tech/images/image-20251231151238474.png" alt="image-20251231151238474"></p><h2 id="_3、seata事务分组" tabindex="-1"><a class="header-anchor" href="#_3、seata事务分组"><span>3、Seata事务分组</span></a></h2><p>我们在前面Seata的使用的过程中知道，在Seata Client端的file.conf配置中，有一个vgroup_mapping属性，它表示事务分组映射，是Seata的资源逻辑，类似于服务实例的概念，主要的作用就是根据分组来获取Seata Server的服务实例</p><h3 id="_3-1、通过事务分组如何找到后端集群" tabindex="-1"><a class="header-anchor" href="#_3-1、通过事务分组如何找到后端集群"><span>3.1、通过事务分组如何找到后端集群？</span></a></h3><ul><li>程序会通过用户配置的配置中心去寻找<code>service.vgroupMapping.[事务分组配置项]</code>，取得配置项的值就是TC集群的名称</li><li>拿到集群名称程序通过一定的前后缀+集群名称去构造服务名，各配置中心的服务名实现不同</li><li>拿到服务名去相应的注册中心去拉取相应服务名的服务列表，获得后端真实的TC服务列表</li></ul><blockquote><p>假如我们有一个项目<code>mall-order-provider</code></p><p>1、它的<code>txServiceGroup=test_tx_group</code>，这个代表该实例的事务分组<code>test_tx_group</code></p><p>2、通过拼接，<code>service.vgroupMapping.test_tx_group</code>，去配置中心查找集群名，得到的是<code>default</code></p><p>3、拼接<code>service.default.grouplist</code>，查找集群名对应的Seata Server的服务地址，从而进行事务的处理</p></blockquote><h3 id="_3-2、为什么设计一个这样的事务分组" tabindex="-1"><a class="header-anchor" href="#_3-2、为什么设计一个这样的事务分组"><span>3.2、为什么设计一个这样的事务分组？</span></a></h3><p>这里多了一层获取事务分组到映射集群的配置。这样设计后，事务分组可以作为资源的逻辑隔离单位，出现某集群故障时可以快速failover，只切换对应分组，可以把故障缩减到服务级别，但前提也是你有足够server集群。</p><h3 id="_3-3、事务分组与高可用" tabindex="-1"><a class="header-anchor" href="#_3-3、事务分组与高可用"><span>3.3、事务分组与高可用</span></a></h3>`,22)),a("p",null,[a("a",k,[s[2]||(s[2]=t("参考资料",-1)),p(n)])]),s[7]||(s[7]=e('<h4 id="_3-3-1、tc异地多机房容灾" tabindex="-1"><a class="header-anchor" href="#_3-3-1、tc异地多机房容灾"><span>3.3.1、TC异地多机房容灾</span></a></h4><blockquote><p>集群出现故障随时切换</p></blockquote><p><img src="http://blog.shengxiao.tech/images/image-20251231162523582.png" alt="image-20251231162523582"></p><h4 id="_3-3-2、单一环境多应用接入" tabindex="-1"><a class="header-anchor" href="#_3-3-2、单一环境多应用接入"><span>3.3.2、单一环境多应用接入</span></a></h4><blockquote><p>将seata集群的不同分组提供给不同的项目的多个服务，比如将a分组给项目A的服务a和服务b，将b分组分配给项目B的服务a和服务b，将c分组分配给C项目的服务a和服务b，从而实现项目A、项目B和项目C这三个项目共用一套seata集群环境</p></blockquote><p><img src="http://blog.shengxiao.tech/images/image-20251231162618491.png" alt="image-20251231162618491"></p><h4 id="_3-3-3、client精细化管理" tabindex="-1"><a class="header-anchor" href="#_3-3-3、client精细化管理"><span>3.3.3、client精细化管理</span></a></h4><blockquote><ul><li>假定现在存在seata集群，Guangzhou机房实例运行在性能较高的机器上，Shanghai集群运行在性能较差的机器上</li><li>现存微服务架构项目projectA、projectA中有微服务ServiceA、ServiceB、ServiceC与ServiceD</li><li>其中ServiceD的流量较小，其余微服务流量较大</li></ul><p>那么此时，我们可以将ServiceD微服务引流到Shanghai集群中去，将高性能的服务器让给其余流量较大的微服务（反之亦然，若存在某一个微服务流量特别大，我们也可以单独为此微服务开辟一个更高性能的集群，并将该client的virtual group指向该集群，其最终目的都是保证在流量洪峰时服务的可用）</p></blockquote><p><img src="http://blog.shengxiao.tech/images/image-20251231163327752.png" alt="image-20251231163327752"></p><h4 id="_3-3-4、seata的预发布环境和生产环境隔离" tabindex="-1"><a class="header-anchor" href="#_3-3-4、seata的预发布环境和生产环境隔离"><span>3.3.4、seata的预发布环境和生产环境隔离</span></a></h4><p><img src="http://blog.shengxiao.tech/images/image-20251231163608629.png" alt="image-20251231163608629"></p><hr><p><img src="http://blog.shengxiao.tech/images/subscribe1.png" alt="扫码关注"></p>',13))])}const b=o(r,[["render",m]]),h=JSON.parse('{"path":"/series/distribution/fenbushishiwu/04fenbushishiwuSeatadegaojiyingyongxiangjie.html","title":"4、分布式事务Seata的高级应用详解","lang":"en-US","frontmatter":{"title":"4、分布式事务Seata的高级应用详解","date":"2025-12-06T00:00:00.000Z","categories":["分布式","事务"],"tags":["分布式","事务","seata"]},"headers":[{"level":2,"title":"1、Seata配置中心","slug":"_1、seata配置中心","link":"#_1、seata配置中心","children":[{"level":3,"title":"1.1、nacos配置","slug":"_1-1、nacos配置","link":"#_1-1、nacos配置","children":[]},{"level":3,"title":"1.2、推送配置","slug":"_1-2、推送配置","link":"#_1-2、推送配置","children":[]},{"level":3,"title":"1.3、集中配置","slug":"_1-3、集中配置","link":"#_1-3、集中配置","children":[]},{"level":3,"title":"1.4、修改客户端配置","slug":"_1-4、修改客户端配置","link":"#_1-4、修改客户端配置","children":[]},{"level":3,"title":"1.5、执行接口","slug":"_1-5、执行接口","link":"#_1-5、执行接口","children":[]}]},{"level":2,"title":"2、Seata注册中心","slug":"_2、seata注册中心","link":"#_2、seata注册中心","children":[{"level":3,"title":"2.1、修改seata-server的配置","slug":"_2-1、修改seata-server的配置","link":"#_2-1、修改seata-server的配置","children":[]},{"level":3,"title":"2.2、客户端配置修改","slug":"_2-2、客户端配置修改","link":"#_2-2、客户端配置修改","children":[]}]},{"level":2,"title":"3、Seata事务分组","slug":"_3、seata事务分组","link":"#_3、seata事务分组","children":[{"level":3,"title":"3.1、通过事务分组如何找到后端集群？","slug":"_3-1、通过事务分组如何找到后端集群","link":"#_3-1、通过事务分组如何找到后端集群","children":[]},{"level":3,"title":"3.2、为什么设计一个这样的事务分组？","slug":"_3-2、为什么设计一个这样的事务分组","link":"#_3-2、为什么设计一个这样的事务分组","children":[]},{"level":3,"title":"3.3、事务分组与高可用","slug":"_3-3、事务分组与高可用","link":"#_3-3、事务分组与高可用","children":[]}]}],"git":{"createdTime":1766909059000,"updatedTime":1767939284000,"contributors":[{"name":"qknavy","email":"qknavy@aliyun.com","commits":4}]},"filePathRelative":"series/distribution/分布式事务/04分布式事务Seata的高级应用详解.md"}');export{b as comp,h as data};
