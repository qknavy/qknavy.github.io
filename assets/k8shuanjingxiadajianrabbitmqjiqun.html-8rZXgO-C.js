import{_ as s,c as a,b as e,o as p}from"./app-CRA4yNID.js";const l={};function t(i,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><p>本文记录在k8s集群环境下采用StatefulSet方式搭建一个三节点的rabbitmq集群，数据挂载方式通过storage的方式挂在到nfs</p></div><p><strong>前置说明：</strong></p><blockquote><p>① k8s版本：v1.28.2</p><p>② 这里数据持久化采用挂载nfs的形式，所以各个节点需要安装nfs客户端，否则创建provisioner的时候会提示连不上nfs。</p><p>以Ubuntu为例：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">apt-get</span> <span class="token function">install</span> nfs-common</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>③ 案例将服务都放在了<code>middleware</code>命名空间里了，可以结合自己的情况替换：</p><blockquote><p>全局替换：sed -i &#39;s/middleware/[自己的namespace]/g&#39; ./*</p></blockquote></blockquote><h2 id="_1、nfs基础支持" tabindex="-1"><a class="header-anchor" href="#_1、nfs基础支持"><span>1、NFS基础支持</span></a></h2><h3 id="_1-1、创建serviceaccount" tabindex="-1"><a class="header-anchor" href="#_1-1、创建serviceaccount"><span>1.1、创建serviceAccount</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2、创建rbac相关资源" tabindex="-1"><a class="header-anchor" href="#_1-2、创建rbac相关资源"><span>1.2、创建rbac相关资源</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner</span>
<span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumes&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumeclaims&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storage.k8s.io&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storageclasses&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">subjects</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner</span>
<span class="line">  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;endpoints&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">subjects</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token comment"># replace with namespace where provisioner is deployed</span></span>
<span class="line">    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>通过上述配置，相当于就给名称为<code>nfs-client-provisioner</code>的serviceAccount赋予了操作集群资源（pvc）的权限</p></blockquote><h3 id="_1-3、创建provisioner" tabindex="-1"><a class="header-anchor" href="#_1-3、创建provisioner"><span>1.3、创建provisioner</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage</span>
<span class="line"><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner <span class="token comment"># or choose another name, must match deployment&#39;s env PROVISIONER_NAME&#39;</span></span>
<span class="line"><span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">strategy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">        <span class="token comment">#image: registry.cn-hangzhou.aliyuncs.com/xhsx/nfs-client-provisioner:latest</span></span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/xhsx/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.0</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.0.101</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> /nfs_win/k8s</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root</span>
<span class="line">        <span class="token key atrule">nfs</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.0.101</span>
<span class="line">          <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs_win/k8s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这里注意使用的镜像，我最开始用的被注释掉的那个镜像，结果pv一直创建失败，提示：waiting for a volume to be created, either by external provisioner &quot;xxxx&quot;</p><p>网上有让改<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>的，但这跟k8s的版本有关系，1.26以上的版本直接用文章上面的镜像就行了</p></blockquote><h2 id="_2、搭建rabbitmq集群" tabindex="-1"><a class="header-anchor" href="#_2、搭建rabbitmq集群"><span>2、搭建rabbitmq集群</span></a></h2><h3 id="_2-1、创建配置" tabindex="-1"><a class="header-anchor" href="#_2-1、创建配置"><span>2.1、创建配置</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> Reconcile</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled_plugins</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">      [rabbitmq_management,rabbitmq_peer_discovery_k8s].</span></span>
<span class="line">    <span class="token key atrule">rabbitmq.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">      loopback_users.guest = false</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment">## Clustering</span></span>
<span class="line">      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s</span>
<span class="line">      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span>
<span class="line">      cluster_formation.k8s.address_type = hostname</span>
<span class="line">      <span class="token comment">#################################################</span></span>
<span class="line">      <span class="token comment"># middleware is rabbitmq-cluster&#39;s namespace#</span></span>
<span class="line">      <span class="token comment">#################################################</span></span>
<span class="line">      cluster_formation.k8s.hostname_suffix = .rmq<span class="token punctuation">-</span>cluster.middleware.svc.cluster.local</span>
<span class="line">      cluster_formation.node_cleanup.interval = 10</span>
<span class="line">      cluster_formation.node_cleanup.only_log_warning = true</span>
<span class="line">      cluster_partition_handling = autoheal</span>
<span class="line">      <span class="token comment">## queue master locator</span></span>
<span class="line">      queue_master_locator=min<span class="token punctuation">-</span>masters</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2、创建secret" tabindex="-1"><a class="header-anchor" href="#_2-2、创建secret"><span>2.2、创建secret</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">stringData</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">cookie</span><span class="token punctuation">:</span> ERLANG_COOKIE</span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> admin</span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> admin@123</span>
<span class="line"><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：理论上这个账号和密码就是后面登录控制台的账号和密码，但是实践发现最后默认的账号还是guest/guest，也就是说这个设置没生效</p></blockquote><h3 id="_2-3、创建svc" tabindex="-1"><a class="header-anchor" href="#_2-3、创建svc"><span>2.3、创建svc</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.96.0.11              <span class="token comment">#指定clusterIP，方便使用</span></span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">15672</span></span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">15672</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> amqp</span>
<span class="line">    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span></span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5672</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4、创建pod" tabindex="-1"><a class="header-anchor" href="#_2-4、创建pod"><span>2.4、创建pod</span></a></h3><blockquote><p>这里用StatefulSet</p></blockquote><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/xhsx/rabbitmq<span class="token punctuation">:</span>3.7<span class="token punctuation">-</span>management</span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">15672</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5672</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> amqp</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> sh</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c</span>
<span class="line">        <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>v /etc/rabbitmq/rabbitmq.conf $<span class="token punctuation">{</span>RABBITMQ_CONFIG_FILE<span class="token punctuation">}</span>; exec docker<span class="token punctuation">-</span>entrypoint.sh</span>
<span class="line">          rabbitmq<span class="token punctuation">-</span>server</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_DEFAULT_USER</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> username</span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>secret</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_DEFAULT_PASS</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>secret</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_ERLANG_COOKIE</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> cookie</span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>secret</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> K8S_SERVICE_NAME</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_IP</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_USE_LONGNAME</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_NODENAME</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> rabbit@$(POD_NAME).rmq<span class="token punctuation">-</span>cluster.$(POD_NAMESPACE).svc.cluster.local</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RABBITMQ_CONFIG_FILE</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/lib/rabbitmq/rabbitmq.conf</span>
<span class="line">        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> rabbitmqctl</span>
<span class="line">            <span class="token punctuation">-</span> status</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> rabbitmqctl</span>
<span class="line">            <span class="token punctuation">-</span> status</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/rabbitmq</span>
<span class="line">          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>storage</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/rabbitmq</span>
<span class="line">          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">items</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> rabbitmq.conf</span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> rabbitmq.conf</span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> enabled_plugins</span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> enabled_plugins</span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>storage</span>
<span class="line">        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>storage</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>storage</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> ReadWriteMany</span>
<span class="line">  <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</span>
<span class="line">  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5、创建ingress网络" tabindex="-1"><a class="header-anchor" href="#_2-5、创建ingress网络"><span>2.5、创建ingress网络</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> rabbitmq<span class="token punctuation">-</span>ingress</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> rabbitmq.shengxiao.com</span>
<span class="line">      <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</span>
<span class="line">            <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</span>
<span class="line">            <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">name</span><span class="token punctuation">:</span> rmq<span class="token punctuation">-</span>cluster</span>
<span class="line">                <span class="token key atrule">port</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">15672</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3、控制台访问" tabindex="-1"><a class="header-anchor" href="#_3、控制台访问"><span>3、控制台访问</span></a></h2><h3 id="_3-1、域名解析" tabindex="-1"><a class="header-anchor" href="#_3-1、域名解析"><span>3.1、域名解析</span></a></h3><p>将上面创建ingress网络的域名解析到ingress-controller所在的节点IP，我这里是瞎写的域名，所以是直接改的<code>/etc/hosts</code>文件</p><h3 id="_3-2、控制台" tabindex="-1"><a class="header-anchor" href="#_3-2、控制台"><span>3.2、控制台</span></a></h3><p>地址：http://rabbitmq.shengxiao.com</p><p><img src="http://blog.shengxiao.tech/images/image-20241127225959813.png" alt="image-20241127225959813"></p><p>输入默认账号：guest/guest即可进入控制台</p><p><img src="http://blog.shengxiao.tech/images/image-20241127230109901.png" alt="image-20241127230109901"></p>`,33)])])}const u=s(l,[["render",t]]),o=JSON.parse('{"path":"/series/container/kubernetes/k8shuanjingxiadajianrabbitmqjiqun.html","title":"k8s环境下搭建rabbitmq集群","lang":"en-US","frontmatter":{"title":"k8s环境下搭建rabbitmq集群","date":"2024-11-28T00:00:00.000Z","categories":["k8s","rabbitmq","容器化"],"tags":["k8s","rabbitmq"]},"headers":[{"level":2,"title":"1、NFS基础支持","slug":"_1、nfs基础支持","link":"#_1、nfs基础支持","children":[{"level":3,"title":"1.1、创建serviceAccount","slug":"_1-1、创建serviceaccount","link":"#_1-1、创建serviceaccount","children":[]},{"level":3,"title":"1.2、创建rbac相关资源","slug":"_1-2、创建rbac相关资源","link":"#_1-2、创建rbac相关资源","children":[]},{"level":3,"title":"1.3、创建provisioner","slug":"_1-3、创建provisioner","link":"#_1-3、创建provisioner","children":[]}]},{"level":2,"title":"2、搭建rabbitmq集群","slug":"_2、搭建rabbitmq集群","link":"#_2、搭建rabbitmq集群","children":[{"level":3,"title":"2.1、创建配置","slug":"_2-1、创建配置","link":"#_2-1、创建配置","children":[]},{"level":3,"title":"2.2、创建secret","slug":"_2-2、创建secret","link":"#_2-2、创建secret","children":[]},{"level":3,"title":"2.3、创建svc","slug":"_2-3、创建svc","link":"#_2-3、创建svc","children":[]},{"level":3,"title":"2.4、创建pod","slug":"_2-4、创建pod","link":"#_2-4、创建pod","children":[]},{"level":3,"title":"2.5、创建ingress网络","slug":"_2-5、创建ingress网络","link":"#_2-5、创建ingress网络","children":[]}]},{"level":2,"title":"3、控制台访问","slug":"_3、控制台访问","link":"#_3、控制台访问","children":[{"level":3,"title":"3.1、域名解析","slug":"_3-1、域名解析","link":"#_3-1、域名解析","children":[]},{"level":3,"title":"3.2、控制台","slug":"_3-2、控制台","link":"#_3-2、控制台","children":[]}]}],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"filePathRelative":"series/container/kubernetes/k8s环境下搭建rabbitmq集群.md"}');export{u as comp,o as data};
