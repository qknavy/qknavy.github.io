import{_ as i,c as t,a as e,b as n,d as l,e as p,r as c,o}from"./app-BFuSdT_a.js";const u={},r={href:"https://github.com/redis/redis",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/redis/redis?tab=readme-ov-file#build-and-run-redis-with-all-data-structures---ubuntu-2004-focal",target:"_blank",rel:"noopener noreferrer"};function k(m,s){const a=c("ExternalLinkIcon");return o(),t("div",null,[s[2]||(s[2]=e('<div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><p>本文介绍redis-8.2.3版本的各种安装部署方式</p></div>',1)),n("p",null,[n("a",r,[s[0]||(s[0]=l("【官网Github】",-1)),p(a)])]),s[3]||(s[3]=n("h2",{id:"_1、源码编译",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1、源码编译"},[n("span",null,"1、源码编译")])],-1)),n("p",null,[n("a",d,[s[1]||(s[1]=l("【参考官方资料】",-1)),p(a)])]),s[4]||(s[4]=e(`<h3 id="_1-1、下载源码包" tabindex="-1"><a class="header-anchor" href="#_1-1、下载源码包"><span>1.1、下载源码包</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#git clone源码，并切换到指定的版本分支或者tag</span></span>
<span class="line"><span class="token function">git</span> clone https://github.com/redis/redis.git</span>
<span class="line"></span>
<span class="line"><span class="token comment">#或者直接下载指定的tag</span></span>
<span class="line"><span class="token function">wget</span> <span class="token parameter variable">-O</span> redis-<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>.tar.gz https://github.com/redis/redis/archive/refs/tags/<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>.tar.gz</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>本文演示采用的是<code>8.2.3</code>版本，用8.2.3替换脚本中的尖括号和<code>version</code>，后续脚本直接用具体版本，注意区分</p></blockquote><h3 id="_1-2、编译" tabindex="-1"><a class="header-anchor" href="#_1-2、编译"><span>1.2、编译</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#解压</span></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-zxf</span> redis-8.2.3.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">cd</span> redis-8.2.3</span>
<span class="line"></span>
<span class="line"><span class="token comment">#安装编译所需要的依赖</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> build-essential</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 编译</span></span>
<span class="line"><span class="token function">make</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行成功之后，就可以运行了</p><h3 id="_1-3、运行" tabindex="-1"><a class="header-anchor" href="#_1-3、运行"><span>1.3、运行</span></a></h3><p>通过上面的编译，没有明确的报错就能够正常运行了</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">./src/redis-server redis.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="http://blog.shengxiao.tech/images/image-20260109101852555.png" alt="image-20260109101852555"></p><p>用redis客户端工具或者直接用客户端去连接，就能正常操作了</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ubuntu@ubuntu-001:~/tools/redis/redis-8.2.3$ ./src/redis-cli</span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> name Navy</span>
<span class="line">OK</span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get name</span>
<span class="line"><span class="token string">&quot;Navy&quot;</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> keys *</span>
<span class="line"><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;name&quot;</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、docker方式运行" tabindex="-1"><a class="header-anchor" href="#_2、docker方式运行"><span>2、docker方式运行</span></a></h2><h3 id="_2-1、首先需要安装docker环境" tabindex="-1"><a class="header-anchor" href="#_2-1、首先需要安装docker环境"><span>2.1、首先需要安装docker环境</span></a></h3><p>安装docker环境这里不讲述，没有基础的可以直接百度</p><h3 id="_2-2、编写docker-compose-yaml文件" tabindex="-1"><a class="header-anchor" href="#_2-2、编写docker-compose-yaml文件"><span>2.2、编写<code>docker-compose.yaml</code>文件</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#39;3&#39;</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">shao_redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always</span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;6379:6379&quot;</span></span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>server</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass 密码 <span class="token comment"># 设置你的密码</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./data<span class="token punctuation">:</span>/data <span class="token comment"># 挂载数据目录，以便密码设置可以持久化</span></span>
<span class="line">      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/logs <span class="token comment"># 挂载日志目录</span></span>
<span class="line">    <span class="token key atrule">deploy</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512M</span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">&#39;0.5&#39;</span></span>
<span class="line">        <span class="token key atrule">reservations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 128M</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里使用的镜像是<code>redis:latest</code>，可以换成具体的版本，比如我自己保存的<code>8.2.3</code>版本的镜像<code>registry.cn-hangzhou.aliyuncs.com/xhsx/redis:8.2.3</code></p><p><code>ports</code>指定了端口映射，将容器的6379端口映射到主机的6379上，这样通过主机的6379端口就可以访问到redis</p><p><code>command</code>命令中<code>--requirepass</code>参数指定了redis的密码，防止redis裸奔提高安全性</p><p><code>volumes</code>挂载了两个目录，一个data是数据目录，另外一个是日志目录，待容器启动成功之后会自动创建这两个目录</p><p><code>resources</code>配置了最小内存、最大内存和最大cpu资源</p><h3 id="_2-3、运行docker-compose" tabindex="-1"><a class="header-anchor" href="#_2-3、运行docker-compose"><span>2.3、运行docker-compose</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sudo</span> <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></span>
<span class="line"></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> redis</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>待容器启动完成后同样可以用客户端工具或者客户端直接连接并操作</p><h2 id="_3、k8s集群部署【集群模式为例】" tabindex="-1"><a class="header-anchor" href="#_3、k8s集群部署【集群模式为例】"><span>3、k8s集群部署【集群模式为例】</span></a></h2><p>前面通过源码方式可docker方式运行了单机版的，接下来体验一下用k8s部署一个redis集群版。当然首先你得有一个k8s集群，这里不讲述k8s集群的搭建</p><h3 id="_3-1、准备配置文件" tabindex="-1"><a class="header-anchor" href="#_3-1、准备配置文件"><span>3.1、准备配置文件</span></a></h3><h4 id="_3-1-1、configmap-yaml" tabindex="-1"><a class="header-anchor" href="#_3-1-1、configmap-yaml"><span>3.1.1、<code>configMap.yaml</code></span></a></h4><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">redis.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    bind 0.0.0.0</span>
<span class="line">    protected-mode yes</span>
<span class="line">    port 6379</span>
<span class="line">    tcp-backlog 511</span>
<span class="line">    timeout 0</span>
<span class="line">    tcp-keepalive 300</span>
<span class="line">    daemonize no</span>
<span class="line">    supervised no</span>
<span class="line">    pidfile /data/redis.pid</span>
<span class="line">    loglevel notice</span>
<span class="line">    logfile /data/redis_log</span>
<span class="line">    databases 16</span>
<span class="line">    always-show-logo yes</span>
<span class="line">    save 900 1</span>
<span class="line">    save 300 10</span>
<span class="line">    save 60 10000</span>
<span class="line">    stop-writes-on-bgsave-error yes</span>
<span class="line">    rdbcompression yes</span>
<span class="line">    rdbchecksum yes</span>
<span class="line">    dbfilename dump.rdb</span>
<span class="line">    dir /data</span>
<span class="line">    masterauth 密码</span>
<span class="line">    replica-serve-stale-data yes</span>
<span class="line">    replica-read-only yes</span>
<span class="line">    repl-diskless-sync no</span>
<span class="line">    repl-diskless-sync-delay 5</span>
<span class="line">    repl-disable-tcp-nodelay no</span>
<span class="line">    replica-priority 100</span>
<span class="line">    requirepass 密码</span>
<span class="line">    lazyfree-lazy-eviction no</span>
<span class="line">    lazyfree-lazy-expire no</span>
<span class="line">    lazyfree-lazy-server-del no</span>
<span class="line">    replica-lazy-flush no</span>
<span class="line">    appendonly no</span>
<span class="line">    appendfilename &quot;appendonly.aof&quot;</span>
<span class="line">    appendfsync everysec</span>
<span class="line">    no-appendfsync-on-rewrite no</span>
<span class="line">    auto-aof-rewrite-percentage 100</span>
<span class="line">    auto-aof-rewrite-min-size 64mb</span>
<span class="line">    aof-load-truncated yes</span>
<span class="line">    aof-use-rdb-preamble yes</span>
<span class="line">    lua-time-limit 5000</span>
<span class="line">    cluster-enabled yes</span>
<span class="line">    cluster-config-file nodes.conf</span>
<span class="line">    cluster-node-timeout 15000</span>
<span class="line">    slowlog-log-slower-than 10000</span>
<span class="line">    slowlog-max-len 128</span>
<span class="line">    latency-monitor-threshold 0</span>
<span class="line">    notify-keyspace-events &quot;&quot;</span>
<span class="line">    hash-max-ziplist-entries 512</span>
<span class="line">    hash-max-ziplist-value 64</span>
<span class="line">    list-max-ziplist-size -2</span>
<span class="line">    list-compress-depth 0</span>
<span class="line">    set-max-intset-entries 512</span>
<span class="line">    zset-max-ziplist-entries 128</span>
<span class="line">    zset-max-ziplist-value 64</span>
<span class="line">    hll-sparse-max-bytes 3000</span>
<span class="line">    stream-node-max-bytes 4096</span>
<span class="line">    stream-node-max-entries 100</span>
<span class="line">    activerehashing yes</span>
<span class="line">    client-output-buffer-limit normal 0 0 0</span>
<span class="line">    client-output-buffer-limit replica 256mb 64mb 60</span>
<span class="line">    client-output-buffer-limit pubsub 32mb 8mb 60</span>
<span class="line">    hz 10</span>
<span class="line">    dynamic-hz yes</span>
<span class="line">    aof-rewrite-incremental-fsync yes</span>
<span class="line">    rdb-save-incremental-fsync yes</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>conf</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意两处配置密码的地方：</p><ul><li>requirepass</li><li>masterauth</li></ul></blockquote><h4 id="_3-1-2、命名空间" tabindex="-1"><a class="header-anchor" href="#_3-1-2、命名空间"><span>3.1.2、命名空间</span></a></h4><p>这里可以看到配置文件的最后面指定了命名空间为<code>middleware</code>，所以要么把所有的命名空间去掉，要么改成自己的命名空间。再要么就自己建一个</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">kubectl create ns middleware</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-2、创建statefulset文件" tabindex="-1"><a class="header-anchor" href="#_3-2、创建statefulset文件"><span>3.2、创建statefulSet文件</span></a></h3><p><code>redis-cluster-sts.yaml</code></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet                                 <span class="token comment">#创建StatefulSet资源</span></span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span>                                         <span class="token comment">#StatefulSet本身的标签</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts                                 <span class="token comment">#资源名称</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware                              <span class="token comment">#资源所属命名空间</span></span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span>                                       <span class="token comment">#标签选择器,要与下面pod模板定义的pod标签保持一致</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">6</span>                                     <span class="token comment">#副本数为6个,redis集群模式最少要为6个节点,构成3主3从</span></span>
<span class="line">  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>svc                          <span class="token comment">#指定使用service为上面我们创建的无头service的名称</span></span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span>                                     <span class="token comment">#pod的标签,上面的无头service的标签选择器和sts标签选择器都要与这个相同</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token comment">#     affinity:</span></span>
<span class="line"><span class="token comment">#       podAntiAffinity:                         #定义pod反亲和性,目的让6个pod不在同一个主机上,实现均衡分布,这里我的node节点不够,所以不定义反亲和性</span></span>
<span class="line"><span class="token comment">#         preferredDuringSchedulingIgnoredDuringExecution:</span></span>
<span class="line"><span class="token comment">#         - weight: 100</span></span>
<span class="line"><span class="token comment">#           podAffinityTerm:</span></span>
<span class="line"><span class="token comment">#             labelSelector:</span></span>
<span class="line"><span class="token comment">#              matchExpressions:</span></span>
<span class="line"><span class="token comment">#               - key: app</span></span>
<span class="line"><span class="token comment">#                 operator: In</span></span>
<span class="line"><span class="token comment">#                 values:</span></span>
<span class="line"><span class="token comment">#                 - redis-sts</span></span>
<span class="line"><span class="token comment">#             topologyKey: kubernetes.io/hostname</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis                               <span class="token comment">#容器名称</span></span>
<span class="line"><span class="token comment">#        image: redis:latest                       #redis镜像</span></span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/xhsx/redis<span class="token punctuation">:</span>latest</span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent             <span class="token comment">#镜像拉取策略</span></span>
<span class="line">        <span class="token key atrule">command</span><span class="token punctuation">:</span>                                  <span class="token comment">#定义容器的启动命令和参数</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token string">&quot;redis-server&quot;</span></span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token string">&quot;/etc/redis/redis.conf&quot;</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token string">&quot;--cluster-announce-ip&quot;</span>                              <span class="token comment">#这个参数和下面的这个参数</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token string">&quot;$(POD_IP)&quot;</span>                                                  <span class="token comment">#这个参数是为了解决pod重启ip变了之后,redis集群状态无法自动同步问题</span></span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_IP                                                   <span class="token comment">#POD_IP值引用自status.podIP</span></span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span>                                    <span class="token comment">#定义容器端口</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span><span class="token number">6379</span>                        <span class="token comment">#为端口取个名称为http</span></span>
<span class="line">          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>                     <span class="token comment">#容器端口</span></span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                             <span class="token comment">#挂载点</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;redis-conf&quot;</span>                      <span class="token comment">#引用下面定义的redis-conf卷</span></span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/redis&quot;</span>                 <span class="token comment">#redis配置文件的挂载点</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;redis-data&quot;</span>                      <span class="token comment">#指定使用的卷名称,这里使用的是下面定义的pvc模板的名称</span></span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/data&quot;</span>                      <span class="token comment">#redis数据的挂载点</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime                                                 <span class="token comment">#挂载本地时间</span></span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime</span>
<span class="line">          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;redis-conf&quot;</span>                        <span class="token comment">#挂载一个名为redis-conf的configMap卷,这个cm卷已经定义好了</span></span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;redis-conf&quot;</span></span>
<span class="line">          <span class="token key atrule">items</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;redis.conf&quot;</span></span>
<span class="line">              <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;redis.conf&quot;</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime                                                 <span class="token comment">#挂载本地时间</span></span>
<span class="line">        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime</span>
<span class="line"><span class="token comment">#          type: File</span></span>
<span class="line">  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>                           <span class="token comment">#定义创建pvc的模板</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;redis-data&quot;</span>                        <span class="token comment">#模板名称</span></span>
<span class="line">      <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span>                                <span class="token comment">#资源请求</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 500M                         <span class="token comment">#需要100M的存储空间</span></span>
<span class="line">        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> ReadWriteOnce                           <span class="token comment">#访问模式为RWO</span></span>
<span class="line">        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;sx-managed-nfs-storage&quot;</span>      <span class="token comment">#指定使用的存储类，实现动态分配pv</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意的是这里采用NFS数据卷挂载的方式进行数据持久化，NFS服务器搭建这里不讲述。</p><h3 id="_3-3、storage-class-yaml" tabindex="-1"><a class="header-anchor" href="#_3-3、storage-class-yaml"><span>3.3、<code>storage-class.yaml</code></span></a></h3><p>上面sts定义文件这里指定了动态数据存储的<code>storageClassName</code>，会通过它动态分配磁盘，这个<code>sx-managed-nfs-storage</code>的定义如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>managed<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>storage</span>
<span class="line"><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner <span class="token comment"># or choose another name, must match deployment&#39;s env PROVISIONER_NAME&#39;</span></span>
<span class="line"><span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">strategy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">        <span class="token comment">#image: registry.cn-hangzhou.aliyuncs.com/xhsx/nfs-client-provisioner:latest</span></span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/xhsx/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.0</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.0.1</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> /nfs_win/k8s</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sx<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root</span>
<span class="line">        <span class="token key atrule">nfs</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.0.1</span>
<span class="line">          <span class="token key atrule">path</span><span class="token punctuation">:</span> /nfs_win/k8s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里指定的是在<code>192.168.0.1</code>这台机器上安装的nfs-server，并指定对应的export路径为<code>/nfs_win/k8s</code></p><h3 id="_3-4、service-account-yaml" tabindex="-1"><a class="header-anchor" href="#_3-4、service-account-yaml"><span>3.4、<code>service-account.yaml</code></span></a></h3><p>上面sc的定义文件这里指定的<code>serviceAccount</code>的定义如下：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5、rbac" tabindex="-1"><a class="header-anchor" href="#_3-5、rbac"><span>3.5、rbac</span></a></h3><p>不仅如此，还要给这个serviceAccount进行授权，也就是rbac的权限绑定</p><p><code>rbac.yaml</code></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner</span>
<span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumes&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumeclaims&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storage.k8s.io&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storageclasses&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">subjects</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner</span>
<span class="line">  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;endpoints&quot;</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding</span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line"><span class="token key atrule">subjects</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">    <span class="token comment"># replace with namespace where provisioner is deployed</span></span>
<span class="line">    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">roleRef</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner</span>
<span class="line">  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6、redis服务" tabindex="-1"><a class="header-anchor" href="#_3-6、redis服务"><span>3.6、redis服务</span></a></h3><p><code>svc.yaml</code></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service                                     <span class="token comment">#先创建一个无头service</span></span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span>                                         <span class="token comment">#service本身的标签</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>svc</span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>svc                                 <span class="token comment">#service的名称,下面创建的StatefulSet就要引用这个service名称</span></span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>                                    <span class="token comment">#service本身的端口</span></span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>                              <span class="token comment">#目标端口6360,redis默认端口是6379,这里为了安全改成了6360</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>sts                                <span class="token comment">#标签选择器要与下面创建的pod的标签一样</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，运行上面的所有yaml就可以得到6个redis的pod</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> rbac.yaml</span>
<span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> service-account.yaml</span>
<span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> storage-class.yaml</span>
<span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> configMap.yaml</span>
<span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> svc.yaml</span>
<span class="line"><span class="token function">sudo</span> kubectl apply <span class="token parameter variable">-f</span> redis-cluster-sts.yaml</span>
<span class="line"></span>
<span class="line"><span class="token comment">#查看启动情况</span></span>
<span class="line"><span class="token function">sudo</span> kubectl <span class="token parameter variable">-n</span> middleware get po <span class="token operator">|</span> <span class="token function">grep</span> redis</span>
<span class="line">redis-sts-0                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               28s</span>
<span class="line">redis-sts-1                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               25s</span>
<span class="line">redis-sts-2                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               22s</span>
<span class="line">redis-sts-3                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               19s</span>
<span class="line">redis-sts-4                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               16s</span>
<span class="line">redis-sts-5                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>               13s</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7、创建集群" tabindex="-1"><a class="header-anchor" href="#_3-7、创建集群"><span>3.7、创建集群</span></a></h3><p>但是，创建集群还需要最终执行一个创建集群的命令，将这6个pod组成一个真正的redis集群</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 先进入某个pod</span></span>
<span class="line"><span class="token function">sudo</span> kubectl <span class="token parameter variable">-n</span> middleware <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-sts-0 <span class="token function">bash</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 执行创建集群命令</span></span>
<span class="line">redis-cli <span class="token parameter variable">-a</span> 密码 <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-0.redis-svc.middleware.svc.cluster.local:6379 <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-1.redis-svc.middleware.svc.cluster.local:6379 <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-2.redis-svc.middleware.svc.cluster.local:6379 <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-3.redis-svc.middleware.svc.cluster.local:6379 <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-4.redis-svc.middleware.svc.cluster.local:6379 <span class="token punctuation">\\</span></span>
<span class="line">redis-sts-5.redis-svc.middleware.svc.cluster.local:6379</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意这里<code>-a</code>参数是前面<code>configMap</code>里边指定的密码，</p><p><code>middleware</code>为前面的命名空间，</p><p><code>redis-sts-x</code>是前面sts定义的时候<code>name</code>的前缀</p><p><code>redis-svc</code>是redis服务的名称</p></blockquote><p><img src="http://blog.shengxiao.tech/images/image-20260109110531645.png" alt="image-20260109110531645"></p><p>看到这个结果就说明集群创建成功了，接下来看一下集群的信息</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment">#连接到集群</span></span>
<span class="line">root@redis-sts-0:/data<span class="token comment"># redis-cli -a 密码 -c</span></span>
<span class="line">Warning: Using a password with <span class="token string">&#39;-a&#39;</span> or <span class="token string">&#39;-u&#39;</span> option on the <span class="token builtin class-name">command</span> line interface may not be safe.</span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看集群信息</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster info</span>
<span class="line">cluster_state:ok</span>
<span class="line">cluster_slots_assigned:16384</span>
<span class="line">cluster_slots_ok:16384</span>
<span class="line">cluster_slots_pfail:0</span>
<span class="line">cluster_slots_fail:0</span>
<span class="line">cluster_known_nodes:6</span>
<span class="line">cluster_size:3</span>
<span class="line">cluster_current_epoch:6</span>
<span class="line">cluster_my_epoch:1</span>
<span class="line">cluster_stats_messages_ping_sent:114</span>
<span class="line">cluster_stats_messages_pong_sent:125</span>
<span class="line">cluster_stats_messages_sent:239</span>
<span class="line">cluster_stats_messages_ping_received:120</span>
<span class="line">cluster_stats_messages_pong_received:114</span>
<span class="line">cluster_stats_messages_meet_received:5</span>
<span class="line">cluster_stats_messages_received:239</span>
<span class="line">total_cluster_links_buffer_limit_exceeded:0</span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看集群节点信息</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster nodes</span>
<span class="line">037fafcc50c3f349953fdc96d549e7b7d9d771aa <span class="token number">10.244</span>.1.142:6379@16379 slave fcd8b11cdbe5e9b859fa358d4bee141bc010ecd1 <span class="token number">0</span> <span class="token number">1767927960059</span> <span class="token number">1</span> connected</span>
<span class="line">2c36183baf724a3b8a2d96485093645411cf43ac <span class="token number">10.244</span>.2.154:6379@16379 master - <span class="token number">0</span> <span class="token number">1767927961066</span> <span class="token number">3</span> connected <span class="token number">10923</span>-16383</span>
<span class="line">d1bae750414d02ff4d32d99fef6a55c480778077 <span class="token number">10.244</span>.2.155:6379@16379 slave 5d8216ed7fe2b144b20b85afa3d2674a738545ce <span class="token number">0</span> <span class="token number">1767927958047</span> <span class="token number">2</span> connected</span>
<span class="line">70b7566832eb544b962c881be72390176274fce6 <span class="token number">10.244</span>.3.116:6379@16379 slave 2c36183baf724a3b8a2d96485093645411cf43ac <span class="token number">0</span> <span class="token number">1767927958000</span> <span class="token number">3</span> connected</span>
<span class="line">fcd8b11cdbe5e9b859fa358d4bee141bc010ecd1 <span class="token number">10.244</span>.3.115:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> connected <span class="token number">0</span>-5460</span>
<span class="line">5d8216ed7fe2b144b20b85afa3d2674a738545ce <span class="token number">10.244</span>.1.141:6379@16379 master - <span class="token number">0</span> <span class="token number">1767927959000</span> <span class="token number">2</span> connected <span class="token number">5461</span>-10922</span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://blog.shengxiao.tech/images/image-20260109111136688.png" alt="image-20260109111136688"></p><h2 id="_4、redis的几种使用方式" tabindex="-1"><a class="header-anchor" href="#_4、redis的几种使用方式"><span>4、redis的几种使用方式</span></a></h2><h3 id="_4-1、单机模式" tabindex="-1"><a class="header-anchor" href="#_4-1、单机模式"><span>4.1、单机模式</span></a></h3><p>维护简单，成本低，一般简单的项目基本上够用</p><h3 id="_4-2、主从模式" tabindex="-1"><a class="header-anchor" href="#_4-2、主从模式"><span>4.2、主从模式</span></a></h3><p><img src="http://blog.shengxiao.tech/images/image-20260109112212668.png" alt="image-20260109112212668"></p><p>在主从模式下，主节点负责处理所有的写操作，并将写操作记录在内存中的缓冲区。从节点从主节点获取这些写操作记录，并在自己的数据库上执行这些操作，从而保持与主节点的数据一致。此外，读请求可以在主节点和从节点上进行，从而实现读写分离，提高系统的读取性能。主从同步的流程大致如下图所示：</p><p><img src="http://blog.shengxiao.tech/images/image-20260109112912367.png" alt="image-20260109112912367"></p><p>步骤：</p><ul><li>1、slave发送SLAVEOF命令，连接到master</li><li>2、slave向master发送一条SYNC命令，触发master开始复制</li><li>3、收到SYNC命令后，主服务器会开始在后台保存其数据快照。同时，主服务器还会记录从接收到SYNC命令开始执行的所有写命令，这些命令将在数据快照完成后发送给从服务器</li><li>4、数据快照完成后，主服务器会将其发送给从服务器。从服务器在接收到数据快照后，会删除所有旧数据，然后使用接收到的数据快照来加载新数据。</li><li>5、数据快照发送完成后，主服务器会将在数据快照过程中记录的所有写命令发送给从服务器。从服务器在接收到这些命令后，会按照接收的顺序执行这些命令，以确保其数据与主服务器的数据保持一致。</li><li>6、完成上述步骤后，主从服务器的数据就同步了。之后，主服务器每执行一次写命令，就会将这个命令发送给所有的从服务器。从服务器在接收到写命令后，会执行这个命令，以确保其数据始终与主服务器的数据保持一致。</li></ul><p><strong>优点：</strong></p><blockquote><p>1、可以实现数据的备份，提高数据的安全性；</p><p>2、读写分离，提高系统的读取性能</p></blockquote><p><strong>局限性：</strong></p><blockquote><p>1、不能自动切换，如果主节点发生故障，从节点不能自动切换为主节点，需要人工干预；</p><p>2、所有的写操作都在主节点上进行，如果写请求量大，主节点可能会成为性能瓶颈。</p></blockquote><h3 id="_4-3、哨兵模式" tabindex="-1"><a class="header-anchor" href="#_4-3、哨兵模式"><span>4.3、哨兵模式</span></a></h3><p>上面说到主从模式无法完成故障时候的主从切换，如何解决这个问题呢？在redis中可以设置哨兵节点，通过哨兵来监听各个节点的状态，一旦发现master不可用了，自动从slave中选择一个成为master。如正常情况下的结构如下图所示：</p><p><img src="http://blog.shengxiao.tech/images/image-20260109114102858.png" alt="image-20260109114102858"></p><p>一旦master挂了失联了，可以选择一个slave顶上去</p><p><img src="http://blog.shengxiao.tech/images/image-20260109114201316.png" alt="image-20260109114201316"></p><p>1、哨兵Sentinel主要负责三个方面的任务：</p><ul><li><strong>监听</strong>：通过发送命令，不间断的监控Redis服务器运行状态，包括主服务器和从服务器。</li><li><strong>提醒</strong>：当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li><li><strong>自动故障迁移（核心任务）</strong>：当哨兵监测到主服务器宕机，会自动在已下线主服务器属下的所有从服务器里面，挑选出一个从服务器将其转换为主服务器(自动切换)。然后通过<strong>发布订阅模式</strong>通知其他的从服务器，修改配置文件，让它们切换主机。</li></ul><p>2、哨兵模式的配置和使用</p><p>配置哨兵模式需要在哨兵节点的配置文件中设置主节点的信息和故障转移的策略，然后启动哨兵节点即可。</p><p>在使用上，用户可以直接向主节点发送写请求，而读请求可以发送到主节点或从节点。</p><p>如果主节点发生故障，用户可以从哨兵节点获取新的主节点信息，然后向新的主节点发送请求。</p><p>3、哨兵模式的优点和局限性</p><ul><li>优点： <ul><li>哨兵模式可以实现故障转移，提高系统的可用性</li><li>哨兵模式可以实现客户端的透明切换，提高系统的可维护性。</li></ul></li><li>局限性： <ul><li>哨兵节点需要额外的资源和维护，增加了系统的复杂性；</li><li>主节点发生故障后，新的主节点可能会有一段时间的数据不一致，影响数据的准确性。</li></ul></li></ul><h3 id="_4-4、集群模式-使用较多" tabindex="-1"><a class="header-anchor" href="#_4-4、集群模式-使用较多"><span>4.4、集群模式（使用较多）</span></a></h3><p>redis的集群模式是一种分布式的解决方案，它允许多个Redis节点（服务器）协同工作，提供更高的性能和可用性。在这种模式下，数据被分片存储在多个节点上，每个节点负责一部分数据的读写。</p><p><img src="http://blog.shengxiao.tech/images/image-20260109115504844.png" alt="image-20260109115504844"></p><p>集群模式主要解决水平拓展问题和整体的高可用（局部节点故障不影响其他节点的数据，因为数据是散列在一个hash环上的，每个节点负责一个hash区间，即使节点不可用影响的也只是hash到这个区间的数据）。如果要保证所有数据的高可用还需要配合主从模式</p><p>在Redis集群模式下，任意一个Master节点都可以接受客户端的请求。当客户端向某个Master节点发送请求时，如果这个请求的键所对应的哈希槽不在这个Master节点负责的范围内，那么这个Master节点会返回一个重定向信息，告诉客户端应该向哪个节点发送请求。这个过程对客户端来说是透明的，客户端只需要按照重定向信息重新发送请求即可。这种方式确保了Redis集群可以有效地处理并分发客户端的请求，提高了系统的性能和可用性。</p><ul><li>优点 <ul><li>集群模式可以实现数据的水平扩展，提高了系统的性能和存储容量；</li><li>集群模式实现高可用性，即使某个节点发生故障，系统仍然可以继续提供服务。</li></ul></li><li>局限性： <ul><li>配置和维护相对复杂，需要管理多个节点；</li><li>某些操作，如多键操作和事务，可能会受到限制。</li></ul></li></ul><h3 id="_4-5、主从、哨兵、集群模式如何选择" tabindex="-1"><a class="header-anchor" href="#_4-5、主从、哨兵、集群模式如何选择"><span>4.5、主从、哨兵、集群模式如何选择</span></a></h3><p>如果你的应用场景主要是读取数据，数据量不大，对数据的一致性要求不高，那么主从模式可能是一个不错的选择。</p><p>如果你的应用场景需要高可用性，即使在主节点发生故障的情况下也需要保证服务的正常运行，那么哨兵模式可能更适合你。</p><p>如果你的应用场景数据量大，需要高性能和高可用性，那么集群模式可能是最好的选择。集群模式可以提供更高的性能，更大的存储容量，以及更好的故障容忍能力。</p><hr><p><img src="http://blog.shengxiao.tech/images/subscribe1.png" alt="扫码关注"></p>`,100))])}const b=i(u,[["render",k]]),h=JSON.parse('{"path":"/series/distribution/Redis/01Redisdeanzhuangbushu.html","title":"1、Redis的安装部署","lang":"en-US","frontmatter":{"title":"1、Redis的安装部署","date":"2026-01-08T00:00:00.000Z","categories":["分布式","Redis"],"tags":["分布式","Redis"],"sticky":2},"headers":[{"level":2,"title":"1、源码编译","slug":"_1、源码编译","link":"#_1、源码编译","children":[{"level":3,"title":"1.1、下载源码包","slug":"_1-1、下载源码包","link":"#_1-1、下载源码包","children":[]},{"level":3,"title":"1.2、编译","slug":"_1-2、编译","link":"#_1-2、编译","children":[]},{"level":3,"title":"1.3、运行","slug":"_1-3、运行","link":"#_1-3、运行","children":[]}]},{"level":2,"title":"2、docker方式运行","slug":"_2、docker方式运行","link":"#_2、docker方式运行","children":[{"level":3,"title":"2.1、首先需要安装docker环境","slug":"_2-1、首先需要安装docker环境","link":"#_2-1、首先需要安装docker环境","children":[]},{"level":3,"title":"2.2、编写docker-compose.yaml文件","slug":"_2-2、编写docker-compose-yaml文件","link":"#_2-2、编写docker-compose-yaml文件","children":[]},{"level":3,"title":"2.3、运行docker-compose","slug":"_2-3、运行docker-compose","link":"#_2-3、运行docker-compose","children":[]}]},{"level":2,"title":"3、k8s集群部署【集群模式为例】","slug":"_3、k8s集群部署【集群模式为例】","link":"#_3、k8s集群部署【集群模式为例】","children":[{"level":3,"title":"3.1、准备配置文件","slug":"_3-1、准备配置文件","link":"#_3-1、准备配置文件","children":[]},{"level":3,"title":"3.2、创建statefulSet文件","slug":"_3-2、创建statefulset文件","link":"#_3-2、创建statefulset文件","children":[]},{"level":3,"title":"3.3、storage-class.yaml","slug":"_3-3、storage-class-yaml","link":"#_3-3、storage-class-yaml","children":[]},{"level":3,"title":"3.4、service-account.yaml","slug":"_3-4、service-account-yaml","link":"#_3-4、service-account-yaml","children":[]},{"level":3,"title":"3.5、rbac","slug":"_3-5、rbac","link":"#_3-5、rbac","children":[]},{"level":3,"title":"3.6、redis服务","slug":"_3-6、redis服务","link":"#_3-6、redis服务","children":[]},{"level":3,"title":"3.7、创建集群","slug":"_3-7、创建集群","link":"#_3-7、创建集群","children":[]}]},{"level":2,"title":"4、redis的几种使用方式","slug":"_4、redis的几种使用方式","link":"#_4、redis的几种使用方式","children":[{"level":3,"title":"4.1、单机模式","slug":"_4-1、单机模式","link":"#_4-1、单机模式","children":[]},{"level":3,"title":"4.2、主从模式","slug":"_4-2、主从模式","link":"#_4-2、主从模式","children":[]},{"level":3,"title":"4.3、哨兵模式","slug":"_4-3、哨兵模式","link":"#_4-3、哨兵模式","children":[]},{"level":3,"title":"4.4、集群模式（使用较多）","slug":"_4-4、集群模式-使用较多","link":"#_4-4、集群模式-使用较多","children":[]},{"level":3,"title":"4.5、主从、哨兵、集群模式如何选择","slug":"_4-5、主从、哨兵、集群模式如何选择","link":"#_4-5、主从、哨兵、集群模式如何选择","children":[]}]}],"git":{"createdTime":1767931287000,"updatedTime":1768009376000,"contributors":[{"name":"qknavy","email":"qknavy@aliyun.com","commits":3}]},"filePathRelative":"series/distribution/Redis/01Redis的安装部署.md"}');export{b as comp,h as data};
