import{_ as l,c as i,b as n,a as t,d as a,e as p,r as c,o}from"./app-ZtzIEswt.js";const u={},r={href:"https://seata.apache.org/zh-cn/docs/user/quickstart/",target:"_blank",rel:"noopener noreferrer"},d={href:"https://github.com/apache/incubator-seata",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/apache/incubator-seata",target:"_blank",rel:"noopener noreferrer"},v={href:"https://seata.apache.org/zh-cn/docs/ops/deploy-guide-beginner",target:"_blank",rel:"noopener noreferrer"},m={href:"https://github.com/apache/incubator-seata/blob/2.x/script/client/at/db/mysql.sql",target:"_blank",rel:"noopener noreferrer"};function b(g,s){const e=c("ExternalLinkIcon");return o(),i("div",null,[n("p",null,[n("a",r,[s[0]||(s[0]=a("Seata官方文档",-1)),p(e)])]),n("p",null,[n("a",d,[s[1]||(s[1]=a("Seata Github",-1)),p(e)])]),s[9]||(s[9]=n("p",null,"Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。",-1)),s[10]||(s[10]=n("h2",{id:"_1、seata的安装部署",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1、seata的安装部署"},[n("span",null,"1、Seata的安装部署")])],-1)),s[11]||(s[11]=n("h3",{id:"_1-1、二进制安装",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1-1、二进制安装"},[n("span",null,"1.1、二进制安装")])],-1)),n("p",null,[n("a",k,[s[2]||(s[2]=a("Github地址",-1)),p(e)])]),n("p",null,[n("a",v,[s[3]||(s[3]=a("安装手册",-1)),p(e)])]),s[12]||(s[12]=t(`<p>从发布版本中下载目标版本的二进制安装包，2.0.0版本之后只提供源码，需要自己编译。为了省事这里下载的是2.0.0版本</p><p><img src="http://blog.shengxiao.tech/images/image-20251226110345482.png" alt="image-20251226110345482"></p><h4 id="_1-1-1、目录结构" tabindex="-1"><a class="header-anchor" href="#_1-1-1、目录结构"><span>1.1.1、目录结构</span></a></h4><p>下载之后解压的目录结构如下：</p><p><img src="http://blog.shengxiao.tech/images/image-20251226110533843.png" alt="image-20251226110533843"></p><ul><li><p>bin：启动脚本，提供了windows和linux的启动脚本</p></li><li><p>conf：配置文件目录</p></li><li><p>target：seata-server.jar存放目录</p></li><li><p>logs：日志目录</p></li></ul><h4 id="_1-1-2、启动" tabindex="-1"><a class="header-anchor" href="#_1-1-2、启动"><span>1.1.2、启动</span></a></h4><p>执行下面命令启动：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">./bin/seata-server.sh</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>看到下面提示表示服务启动成功</p><p><img src="http://blog.shengxiao.tech/images/image-20251226111514812.png" alt="image-20251226111514812"></p><p>可以啊看到，这里提示服务启动成功，日志目录在对应标注的位置</p><p><img src="http://blog.shengxiao.tech/images/image-20251226111632606.png" alt="image-20251226111632606"></p><p>查看日志：</p><p><img src="http://blog.shengxiao.tech/images/image-20251226111801067.png" alt="image-20251226111801067"></p><h4 id="_1-1-3、ui控制台" tabindex="-1"><a class="header-anchor" href="#_1-1-3、ui控制台"><span>1.1.3、UI控制台</span></a></h4><p>从上面的启动日志可以看到这里提示还有一个控制台，必须得看一眼，于是输入真实的IP和端口号就可以看到</p><p><img src="http://blog.shengxiao.tech/images/image-20251226111934568.png" alt="image-20251226111934568"></p><p>用默认的账号和密码进去：账号（seata），密码（seata）</p><p><img src="http://blog.shengxiao.tech/images/image-20251226112411355.png" alt="image-20251226112411355"></p><p>这个控制台主要就是提供了可视化的事务管理功能，包括事务信息、全局锁信息和saga状态机的设计器</p><h3 id="_1-2、docker安装" tabindex="-1"><a class="header-anchor" href="#_1-2、docker安装"><span>1.2、docker安装</span></a></h3><h4 id="_1-2-1、镜像构建" tabindex="-1"><a class="header-anchor" href="#_1-2-1、镜像构建"><span>1.2.1、镜像构建</span></a></h4><p>从下载的解压包可以看到一个<code>Dockerfile</code>文件，通过这个文件就可以构建自己的seata-server的镜像</p><p><code>Dockerfile</code>内容如下：</p><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker" data-title="docker"><pre><code><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> openjdk:8u342</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># set label</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> maintainer=<span class="token string">&quot;Seata &lt;seata.io&gt;&quot;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /<span class="token variable">$BASE_DIR</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ADD FORM distribution</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> bin/ /seata-server/bin</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> ext/ /seata-server/ext</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> target/ /seata-server/target</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> lib/ /seata-server/lib</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> conf/ /seata-server/conf</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> LICENSE /seata-server/LICENSE</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># set extra environment</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> LOADER_PATH=<span class="token string">&quot;/seata-server/lib&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> TZ=<span class="token string">&quot;Asia/Shanghai&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;bash&quot;</span>,<span class="token string">&quot;-c&quot;</span>,<span class="token string">&quot;/seata-server/bin/seata-server.sh &amp;&amp; tail -f /dev/null&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过<code>docker build . -t xxx</code>就可以构建自己的镜像了，当然，也可以用别人已经构建好的镜像，直接拉取下来用就行</p><h4 id="_1-2-2、docker-compose启动" tabindex="-1"><a class="header-anchor" href="#_1-2-2、docker-compose启动"><span>1.2.2、docker-compose启动</span></a></h4><p>在解压目录下的<code>script/server/docker-compose</code>目录下有一个<code>docker-compose.yaml</code>文件：</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">seata-server</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> seataio/seata<span class="token punctuation">-</span>server</span>
<span class="line">    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;8091:8091&quot;</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> SEATA_PORT=8091</span>
<span class="line">      <span class="token punctuation">-</span> STORE_MODE=file</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>找到这个文件，直接运行<code>docker-compose up -d</code>就可以启动seata-server了，这里会自动拉取<code>seataio/seata-server:latest</code>最新镜像，如果要用自己构建的镜像，就需要替换这个镜像名称</p><h3 id="_1-3、k8s安装" tabindex="-1"><a class="header-anchor" href="#_1-3、k8s安装"><span>1.3、k8s安装</span></a></h3><p>下面脚本是部署在<code>middleware</code>命名空间下的，如果命名空间不存在，要么创建一个，要么改成自己k8s集群已经存在的命名空间</p><h4 id="_1-3-1、配置文件cm" tabindex="-1"><a class="header-anchor" href="#_1-3-1、配置文件cm"><span>1.3.1、配置文件cm</span></a></h4><p><code>application-cm.yaml</code></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">application.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    server:</span>
<span class="line">      port: 7091</span></span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">spring</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">application</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">logging</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>logback<span class="token punctuation">-</span>spring.xml</span>
<span class="line">      <span class="token key atrule">file</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>user.home<span class="token punctuation">}</span>/logs/seata</span>
<span class="line">      <span class="token key atrule">extend</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">logstash-appender</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">destination</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">4560</span></span>
<span class="line">        <span class="token key atrule">kafka-appender</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">9092</span></span>
<span class="line">          <span class="token key atrule">topic</span><span class="token punctuation">:</span> logback_to_logstash</span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">console</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">user</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">username</span><span class="token punctuation">:</span> seata</span>
<span class="line">        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">&#39;Seata!@#&#39;</span></span>
<span class="line"></span>
<span class="line">    <span class="token key atrule">seata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">config</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">        <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.101<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">          <span class="token comment">#namespace: prod</span></span>
<span class="line">          <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">          <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">          <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">          <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties</span>
<span class="line">      <span class="token key atrule">registry</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos</span>
<span class="line">        <span class="token key atrule">nacos</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">          <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.0.101<span class="token punctuation">:</span><span class="token number">8848</span></span>
<span class="line">          <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP</span>
<span class="line">          <span class="token comment">#namespace: prod</span></span>
<span class="line">          <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default</span>
<span class="line">          <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos</span>
<span class="line">          <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos</span>
<span class="line">      <span class="token key atrule">security</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> SeataSecretKey0c382ef121d778043159209298fd40bf3850aaaa</span>
<span class="line">        <span class="token key atrule">tokenValidityInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span></span>
<span class="line">        <span class="token key atrule">ignore</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">urls</span><span class="token punctuation">:</span> /<span class="token punctuation">,</span>/<span class="token important">**/*.css</span><span class="token punctuation">,</span>/<span class="token important">**/*.js</span><span class="token punctuation">,</span>/<span class="token important">**/*.html</span><span class="token punctuation">,</span>/<span class="token important">**/*.map</span><span class="token punctuation">,</span>/<span class="token important">**/*.svg</span><span class="token punctuation">,</span>/<span class="token important">**/*.png</span><span class="token punctuation">,</span>/<span class="token important">**/*.ico</span><span class="token punctuation">,</span>/console<span class="token punctuation">-</span>fe/public/<span class="token important">**</span><span class="token punctuation">,</span>/api/v1/auth/login</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里指定了console.user.username、console-user.password，同时配置了注册中心和配置中心为nacos，具体配置说明可以参考官方文档</p><h4 id="_1-3-2、deploy" tabindex="-1"><a class="header-anchor" href="#_1-3-2、deploy"><span>1.3.2、deploy</span></a></h4><p><code>deploy.yaml</code></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/xhsx/seata<span class="token punctuation">-</span>server<span class="token punctuation">:</span>latest</span>
<span class="line">          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">          <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span><span class="token number">7091</span></span>
<span class="line">              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7091</span></span>
<span class="line">              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span><span class="token number">8091</span></span>
<span class="line">              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8091</span></span>
<span class="line">              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>config</span>
<span class="line">              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /seata<span class="token punctuation">-</span>server/resources/application.yml</span>
<span class="line">              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> application.yml</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>config</span>
<span class="line">          <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server<span class="token punctuation">-</span>config</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我这里用的镜像是从官方拉取然后保存在阿里云镜像仓库里的，需要根据具体情况替换</p><h4 id="_1-3-3、运行" tabindex="-1"><a class="header-anchor" href="#_1-3-3、运行"><span>1.3.3、运行</span></a></h4><p>有了配置文件<code>application-cm.yaml</code>和<code>deploy.yaml</code>之后就可以执行k8s命令启动了</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">kubectl <span class="token parameter variable">-f</span> application-cm.yaml</span>
<span class="line">kubectl <span class="token parameter variable">-f</span> deploy.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看容器是否正常启动</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ubuntu@ubuntu-server-01:~/k8s/seata$ <span class="token function">sudo</span> kubectl <span class="token parameter variable">-n</span> middleware get po <span class="token operator">|</span> <span class="token function">grep</span> seat</span>
<span class="line">seata-server-65649cbfd-5b5fd                 <span class="token number">1</span>/1     Running   <span class="token number">28</span> <span class="token punctuation">(</span>44d ago<span class="token punctuation">)</span>    252d</span>
<span class="line">seata-server-65649cbfd-dzxc8                 <span class="token number">1</span>/1     Running   <span class="token number">28</span> <span class="token punctuation">(</span>44d ago<span class="token punctuation">)</span>    252d</span>
<span class="line">seata-server-65649cbfd-l9676                 <span class="token number">1</span>/1     Running   <span class="token number">28</span> <span class="token punctuation">(</span>44d ago<span class="token punctuation">)</span>    252d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-4、service" tabindex="-1"><a class="header-anchor" href="#_1-3-4、service"><span>1.3.4、service</span></a></h4><p>我们都知道，k8s集群部署的容器是无法直接在外部使用的，要么将要访问seata-server的程序也部署到k8s里边，要么就要通过service将seata-server服务暴露出来，这里可以用到<code>nodeport</code>类型的service</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> middleware</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8091</span></span>
<span class="line">      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30893</span></span>
<span class="line">      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span><span class="token number">8091</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7091</span></span>
<span class="line">      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30793</span></span>
<span class="line">      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span><span class="token number">7091</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过k8s集群的节点IP+30793访问UI控制台可以看到也能正常访问，账号和密码是我们上面<code>application-cm.yaml</code>配置的<code>seata</code>和<code>Seata!@#</code></p><p><img src="http://blog.shengxiao.tech/images/image-20251226115103094.png" alt="image-20251226115103094"></p><p><img src="http://blog.shengxiao.tech/images/image-20251226115315438.png" alt="image-20251226115315438"></p><h2 id="_2、seata提供的四种事务模式" tabindex="-1"><a class="header-anchor" href="#_2、seata提供的四种事务模式"><span>2、Seata提供的四种事务模式</span></a></h2><h3 id="_2-1、at模式" tabindex="-1"><a class="header-anchor" href="#_2-1、at模式"><span>2.1、AT模式</span></a></h3><h4 id="_2-1-1、at模式事务执行流程" tabindex="-1"><a class="header-anchor" href="#_2-1-1、at模式事务执行流程"><span>2.1.1、AT模式事务执行流程</span></a></h4><p>Seata的AT模式是基于数据库本身的ACID基础上实现的，也是默认的模式，AT 模式是 Seata 创新的一种非侵入式的分布式事务解决方案，Seata 在内部做了对数据库操作的代理层，它对我们的数据源进行了进一步包装，提供了一个DatasourceProxy数据源代理</p><p><img src="http://blog.shengxiao.tech/images/image-20251225143829087.png" alt="image-20251225143829087"></p><p>AT模式的两阶段提交：</p>`,58)),n("ul",null,[n("li",null,[s[5]||(s[5]=a("一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源（需要在本地数据库中创建一张表，",-1)),s[6]||(s[6]=n("code",null,"undo_log",-1)),s[7]||(s[7]=a(" 表，2.x版本的sql脚本地址：",-1)),n("a",m,[s[4]||(s[4]=a("sql",-1)),p(e)]),s[8]||(s[8]=a("）。",-1))])]),s[13]||(s[13]=t(`<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span></span>
<span class="line"><span class="token punctuation">(</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span>     <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>context<span class="token punctuation">\`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>rollback_info<span class="token punctuation">\`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_status<span class="token punctuation">\`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token identifier"><span class="token punctuation">\`</span>log_modified<span class="token punctuation">\`</span></span>  <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>ux_undo_log<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>xid<span class="token punctuation">\`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">\`</span>branch_id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COMMENT</span> <span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>undo_log<span class="token punctuation">\`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">\`</span>ix_log_created<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>log_created<span class="token punctuation">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>undo_log的内容大概如下，记录了修改前和修改后的完整内容，如果事务要进行回滚，则会根据<code>sqlType</code>通过sql解析器生成一个逆向sql去回滚</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span></span>
<span class="line">	<span class="token property">&quot;branchId&quot;</span><span class="token operator">:</span> <span class="token number">641789253</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">&quot;undoItems&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token property">&quot;afterImage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">				<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GTS&quot;</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;since&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014&quot;</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token property">&quot;beforeImage&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token property">&quot;rows&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">				<span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;TXC&quot;</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">					<span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;since&quot;</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2014&quot;</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token property">&quot;tableName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token property">&quot;sqlType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UPDATE&quot;</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token property">&quot;xid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xid:xxx&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>二阶段： <ul><li>提交事务，异步化，非常快速地完成。</li><li>事务回滚，通过一阶段的回滚日志进行反向补偿。</li></ul></li></ul><h4 id="_2-1-2、写隔离" tabindex="-1"><a class="header-anchor" href="#_2-1-2、写隔离"><span>2.1.2、写隔离</span></a></h4><p>Seata的AT模式写隔离是基于全局锁来实现的，以官网的一个示例来说明：</p><p>两个全局事务 tx1 和 tx2，分别对 a 表的 m 字段进行更新操作，m 的初始值 1000。</p><p>tx1 先开始，开启本地事务，拿到本地锁，更新操作 m = 1000 - 100 = 900。本地事务提交前，先拿到该记录的 <strong>全局锁</strong> ，本地提交释放本地锁。 tx2 后开始，开启本地事务，拿到本地锁，更新操作 m = 900 - 100 = 800。本地事务提交前，尝试拿该记录的 <strong>全局锁</strong> ，tx1 全局提交前，该记录的全局锁被 tx1 持有，tx2 需要重试等待 <strong>全局锁</strong> 。</p><p><img src="http://blog.shengxiao.tech/images/image-20251226152448829.png" alt="image-20251226152448829"></p><p>tx1 二阶段全局提交，释放 <strong>全局锁</strong> 。tx2 拿到 <strong>全局锁</strong> 提交本地事务。</p><p>如果 tx1 的二阶段全局回滚，则 tx1 需要重新获取该数据的本地锁，进行反向补偿的更新操作，实现分支的回滚。</p><p><img src="http://blog.shengxiao.tech/images/image-20251226152542450.png" alt="image-20251226152542450"></p><p>此时，如果 tx2 仍在等待该数据的 <strong>全局锁</strong>，同时持有本地锁，则 tx1 的分支回滚会失败。分支的回滚会一直重试，直到 tx2 的 <strong>全局锁</strong> 等锁超时，放弃 <strong>全局锁</strong> 并回滚本地事务释放本地锁，tx1 的分支回滚最终成功。</p><p>因为整个过程 <strong>全局锁</strong> 在 tx1 结束前一直是被 tx1 持有的，所以不会发生 <strong>脏写</strong> 的问题。</p><h4 id="_2-1-2、读隔离" tabindex="-1"><a class="header-anchor" href="#_2-1-2、读隔离"><span>2.1.2、读隔离</span></a></h4><p>在数据库本地事务隔离级别 <strong>读已提交（Read Committed）</strong> 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>读未提交（Read Uncommitted）</strong> 。</p><p>如果应用在特定场景下，必需要求全局的 <strong>读已提交</strong> ，目前 Seata 的方式是通过 SELECT FOR UPDATE 语句的代理。</p><p>SELECT FOR UPDATE 语句的执行会申请 <strong>全局锁</strong> ，如果 <strong>全局锁</strong> 被其他事务持有，则释放本地锁（回滚 SELECT FOR UPDATE 语句的本地执行）并重试。这个过程中，查询是被 block 住的，直到 <strong>全局锁</strong> 拿到，即读取的相关数据是 <strong>已提交</strong> 的，才返回。</p><p><img src="http://blog.shengxiao.tech/images/image-20251226152729967.png" alt="image-20251226152729967"></p><p>出于总体性能上的考虑，Seata 目前的方案并没有对所有 SELECT 语句都进行代理，仅针对 FOR UPDATE 的 SELECT 语句。</p><h3 id="_2-2、tcc模式" tabindex="-1"><a class="header-anchor" href="#_2-2、tcc模式"><span>2.2、TCC模式</span></a></h3><p>TCC模式是一种代码侵入的分布式事务解决方案，它不依赖底层数据库，完全由程序员自己通过代码控制，我们需要给分布式事务方法除了提供具体的业务方法之外，还需要手动去实现业务逻辑正常执行的时候的事务提交的方法以及业务逻辑执行失败的时候的事务回滚方法，也就是Try、Confirm、Cancel这三个方法都需要我们去实现</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TccActionOne</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@TwoPhaseBusinessAction</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;DubboTccActionOne&quot;</span><span class="token punctuation">,</span> commitMethod <span class="token operator">=</span> <span class="token string">&quot;commit&quot;</span><span class="token punctuation">,</span> rollbackMethod <span class="token operator">=</span> <span class="token string">&quot;rollback&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> actionContext<span class="token punctuation">,</span> <span class="token annotation punctuation">@BusinessActionContextParameter</span><span class="token punctuation">(</span>paramName <span class="token operator">=</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> actionContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> actionContext<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-1、tcc模式事务执行流程" tabindex="-1"><a class="header-anchor" href="#_2-2-1、tcc模式事务执行流程"><span>2.2.1、TCC模式事务执行流程</span></a></h4><p><img src="http://blog.shengxiao.tech/images/image-20251226150718935.png" alt="image-20251226150718935"></p><p>上图TM为事务管理器，简单理解就是我们开启全局事务的地方，RM是资源管理器，比如数据库，TC为事务协调器，也就是seata-server。上述流程概括就是：</p><ul><li>TM开启全局事务，向TC注册一个全局事务，并会得到一个全局事务ID</li><li>全局事务里边包含两个子业务，这两个子业务分别会向TC也就是<code>seata-server</code>注册一个分支事务</li><li>两个子业务执行结束预提交，并且向<code>seata-server</code>主动上报prepare阶段的分支事务状态</li><li>如果所有的分支事务都执行成功，TM会通知TC提交全局事务，TC会通知各分支事务进行提交。反之则会通知进行回滚</li></ul><h4 id="_2-2-2、tcc模式下的空回滚问题" tabindex="-1"><a class="header-anchor" href="#_2-2-2、tcc模式下的空回滚问题"><span>2.2.2、TCC模式下的空回滚问题</span></a></h4><p>由于TCC是基于补偿的机制，件一个事务拆分成了三个环节。假如现在因为网络问题，Try阶段因为超时导致了事务执行失败，按照逻辑全局事务就会执行Cancel逻辑进行回滚。</p><p>当时由于我们的try都没有执行，比如是A往B转100块钱，那么回滚的话就会B往A转100块钱。当时现在前一个逻辑没有执行，这样一来B不就亏大发了吗？</p><p>则就是TCC的空回滚问题，怎么解决？</p><p><strong>方案</strong>：本地事务控制表</p><p>设计一张表，记录下本次事务相关的信息，与try阶段的本地事务一起写入，在cancel阶段 去这张事务控制表去查，如果有对应的记录，则说明try阶段执行成功了，反之则说明try阶段没有执行</p><h4 id="_2-2-3、tcc模式下的幂等性问题" tabindex="-1"><a class="header-anchor" href="#_2-2-3、tcc模式下的幂等性问题"><span>2.2.3、TCC模式下的幂等性问题</span></a></h4><p>在TC通知RM提交分支事务的时候，如果因为网络超时没有收到对方的响应，它会重复发送提交或者回滚的通知。如何这个时候不考虑消息的幂等性，则会出现数据的不一致问题</p><p>Confirm和Cancel则两个环节的幂等性如何保障呢？</p><p><strong>方案</strong>：状态机</p><p>设计一个状态机，方法的执行与否会根据事务的状态去判断，并且状态是不可逆的，这样当指定状态已经发出一次修改之后，就无法再通过该状态修改同一条数据了</p><h4 id="_2-2-4、tcc模式下的空悬挂问题" tabindex="-1"><a class="header-anchor" href="#_2-2-4、tcc模式下的空悬挂问题"><span>2.2.4、TCC模式下的空悬挂问题</span></a></h4><p>我们知道分布式场景下网络是不可靠的，假如我们前面已经开启了允许空回滚问题，这个时候如果是因为网络延迟，try执行超时导致了回滚，这个时候cancel先执行了，当时实际上try阶段的请求已经发送出去了，这个时候try会在cancel之后执行，这种情况同样会出现数据一致性问题，这就是空悬挂问题。</p><p>怎么解决呢？</p><p><strong>方案</strong>：本地事务控制表</p><p>方案还是通过一张本地事务控制表来控制。前面可以通过这张表来判断cancel是否需要执行，那么反过来同样也可以通过这张表来控制try是否能够执行。也就是说在cancel阶段写入这张表，然后在try方法执行的时候去这张表里去查，如果对应事务的cancel操作执行了，则不允许在执行try操作</p><h3 id="_2-3、xa模式" tabindex="-1"><a class="header-anchor" href="#_2-3、xa模式"><span>2.3、XA模式</span></a></h3><p>XA 模式是从 1.2 版本支持的强一致性事务模式。XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准。Seata XA 模式是利用事务资源（数据库、消息服务等）对 XA 协议的支持，以 XA 协议的机制来管理分支事务的一种事务模式。</p><p><img src="http://blog.shengxiao.tech/images/image-20251226162828913.png" alt="image-20251226162828913"></p><p><strong>缺点：</strong></p><p>XA prepare 后，分支事务进入阻塞阶段，收到 XA commit 或 XA rollback 前必须阻塞等待。事务资源长时间得不到释放，锁定周期长，而且在应用层上面无法干预，性能差</p><h3 id="_2-4、saga模式" tabindex="-1"><a class="header-anchor" href="#_2-4、saga模式"><span>2.4、saga模式</span></a></h3><p>Saga 模式是 SEATA 提供的长事务解决方案，在 Saga 模式中，业务流程中每个参与者都提交本地事务，当出现某一个参与者失败则补偿前面已经成功的参与者，一阶段正向服务和二阶段补偿服务都由业务开发实现。</p><p><img src="http://blog.shengxiao.tech/images/image-20251226163204889.png" alt="image-20251226163204889"></p><p>前面看UI控制台的时候可以看到一个<code>Saga状态机设计器</code>菜单，实际上seata的saga模式是基于状态机引擎来实现的：</p><ul><li>1、通过状态图来定义服务调用的流程并生成 json 状态语言定义文件</li><li>2、状态图中一个节点可以是调用一个服务，节点可以配置它的补偿节点</li><li>3、状态图 json 由状态机引擎驱动执行，当出现异常时状态引擎反向执行已成功节点对应的补偿节点将事务回滚</li></ul><blockquote><p>注意: 异常发生时是否进行补偿也可由用户自定义决定</p></blockquote><ul><li>4、可以实现服务编排需求，支持单项选择、并发、子流程、参数转换、参数映射、服务执行状态判断、异常捕获等功能</li></ul><h2 id="_3、at模式示例" tabindex="-1"><a class="header-anchor" href="#_3、at模式示例"><span>3、AT模式示例</span></a></h2><p>https://github.com/apache/incubator-seata-samples/tree/master/at-sample</p><p>以SpringBoot+Dubbo+Seata为例</p><h3 id="_3-1、引入依赖" tabindex="-1"><a class="header-anchor" href="#_3-1、引入依赖"><span>3.1、引入依赖</span></a></h3><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre><code><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>其它集成所需要的依赖这里没有列出</p></blockquote><h3 id="_3-2、配置文件" tabindex="-1"><a class="header-anchor" href="#_3-2、配置文件"><span>3.2、配置文件</span></a></h3><div class="language-properties line-numbers-mode" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token key attr-name">seata.tx-service-group</span><span class="token punctuation">=</span><span class="token value attr-value">my_test_tx_group</span></span>
<span class="line"><span class="token key attr-name">seata.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">seata.service.vgroup-mapping.my_test_tx_group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span></span>
<span class="line"><span class="token key attr-name">seata.service.grouplist.default</span><span class="token punctuation">=</span><span class="token value attr-value">\${seata.address:127.0.0.1}:8091</span></span>
<span class="line"><span class="token key attr-name">seata.registry.type</span><span class="token punctuation">=</span><span class="token value attr-value">file</span></span>
<span class="line"><span class="token key attr-name">seata.config.type</span><span class="token punctuation">=</span><span class="token value attr-value">file</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里会根据<code>seata.tx-service-group</code>对应的值去找<code>seata.service.vgroup-mapping</code>为前缀的配置项的值<code>default</code>，这个<code>default</code>就是seata-server的集群分组，程序会再去找<code>seata.service.grouplist</code>+<code>default</code>对应的seata-server的地址。</p><p>注册中心和配置中心的配置方式参考官方文档。</p><h3 id="_3-3、开启事务" tabindex="-1"><a class="header-anchor" href="#_3-3、开启事务"><span>3.3、开启事务</span></a></h3><p>在需要开启全局事务的方法上打上注解</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>timeoutMills <span class="token operator">=</span> <span class="token number">300000</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;spring-dubbo-tx&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>AT模式在使用起来应该是非常简单的了，为了我们的应用数据的安全稳定，不妨把seata用起来吧</p><hr><p><img src="http://blog.shengxiao.tech/images/subscribe1.png" alt="扫码关注"></p>`,71))])}const y=l(u,[["render",b]]),q=JSON.parse('{"path":"/series/distribution/fenbushishiwu/02fenbushishiwuSeatadeyingyongyuyuanlifenxi.html","title":"2、分布式事务Seata的应用与原理分析","lang":"en-US","frontmatter":{"title":"2、分布式事务Seata的应用与原理分析","date":"2025-11-03T00:00:00.000Z","categories":["事务","分布式"],"tags":["事务","分布式"]},"headers":[{"level":2,"title":"1、Seata的安装部署","slug":"_1、seata的安装部署","link":"#_1、seata的安装部署","children":[{"level":3,"title":"1.1、二进制安装","slug":"_1-1、二进制安装","link":"#_1-1、二进制安装","children":[]},{"level":3,"title":"1.2、docker安装","slug":"_1-2、docker安装","link":"#_1-2、docker安装","children":[]},{"level":3,"title":"1.3、k8s安装","slug":"_1-3、k8s安装","link":"#_1-3、k8s安装","children":[]}]},{"level":2,"title":"2、Seata提供的四种事务模式","slug":"_2、seata提供的四种事务模式","link":"#_2、seata提供的四种事务模式","children":[{"level":3,"title":"2.1、AT模式","slug":"_2-1、at模式","link":"#_2-1、at模式","children":[]},{"level":3,"title":"2.2、TCC模式","slug":"_2-2、tcc模式","link":"#_2-2、tcc模式","children":[]},{"level":3,"title":"2.3、XA模式","slug":"_2-3、xa模式","link":"#_2-3、xa模式","children":[]},{"level":3,"title":"2.4、saga模式","slug":"_2-4、saga模式","link":"#_2-4、saga模式","children":[]}]},{"level":2,"title":"3、AT模式示例","slug":"_3、at模式示例","link":"#_3、at模式示例","children":[{"level":3,"title":"3.1、引入依赖","slug":"_3-1、引入依赖","link":"#_3-1、引入依赖","children":[]},{"level":3,"title":"3.2、配置文件","slug":"_3-2、配置文件","link":"#_3-2、配置文件","children":[]},{"level":3,"title":"3.3、开启事务","slug":"_3-3、开启事务","link":"#_3-3、开启事务","children":[]}]}],"git":{"createdTime":1766801010000,"updatedTime":1767939284000,"contributors":[{"name":"qknavy","email":"qknavy@aliyun.com","commits":3}]},"filePathRelative":"series/distribution/分布式事务/02分布式事务Seata的应用与原理分析.md"}');export{y as comp,q as data};
